<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estadísticas - TEYCKETAN</title>
    <link rel="stylesheet" href="proveedor.css"> <!-- Asegúrate que la ruta a tu CSS es correcta -->
</head>
<body>
    <header>
        <h1>Panel del Proveedor</h1>
        <nav>
            <ul>
                <li><a href="proveedorPanel.html">Inicio</a></li>
                <li><a href="eventoprov.html">Crear Evento</a></li>
                <li><a href="editarprov.html">Editar Evento</a></li>
                <li><a href="estadisticas.html" class="activo">Estadísticas</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section>
            <h2>Estadísticas de tus Eventos</h2>
            <div id="message-container" style="margin-top: 20px;"></div>
            <div class="contenedor-eventos" id="stats-list">
                <p>Cargando estadísticas...</p>
            </div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const statsList = document.getElementById('stats-list');
            const messageContainer = document.getElementById('message-container');
            const token = localStorage.getItem('jwtToken');

            if (!token) {
                showMessage('No estás autenticado. Por favor, inicia sesión.', 'error');
                window.location.href = 'login.html';
                return;
            }

            function showMessage(msg, type) {
                messageContainer.innerHTML = `<p style="color: ${type === 'error' ? 'red' : 'green'};">${msg}</p>`;
                setTimeout(() => { messageContainer.innerHTML = ''; }, 5000);
            }

            async function fetchStats() {
                statsList.innerHTML = '<p>Cargando estadísticas...</p>';
                messageContainer.innerHTML = '';

                try {
                    const response = await fetch('http://localhost:3000/api/proveedor/eventos/estadisticas', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await response.json();

                    if (response.ok) {
                        renderStats(data);
                    } else {
                        showMessage(`Error al cargar estadísticas: ${data.error || data.message || 'Error desconocido'}`, 'error');
                        statsList.innerHTML = '<p>No se pudieron cargar las estadísticas.</p>';
                    }
                } catch (error) {
                    console.error('Error al obtener estadísticas:', error);
                    showMessage('Error de conexión al cargar estadísticas.', 'error');
                    statsList.innerHTML = '<p>Error de red.</p>';
                }
            }

            function renderStats(statsData) {
                statsList.innerHTML = ''; // Limpiar contenido estático

                if (statsData.totalEventosCreados === 0) {
                    statsList.innerHTML = '<p>No tienes eventos creados para mostrar estadísticas.</p>';
                    return;
                }

                let htmlContent = `
                    <h3>Resumen General:</h3>
                    <p><strong>Total Eventos Creados:</strong> ${statsData.totalEventosCreados}</p>
                    <p><strong>Total Eventos Activos:</strong> ${statsData.totalEventosActivos}</p>
                    <hr>
                    <h3>Estadísticas por Evento:</h3>
                `;

                if (statsData.estadisticasEventos && statsData.estadisticasEventos.length > 0) {
                    statsData.estadisticasEventos.forEach(eventStat => {
                        htmlContent += `
                            <div class="evento">
                                <p><strong>Evento:</strong> ${eventStat.Nom_Evento}</p>
                                <p><strong>ID Evento:</strong> ${eventStat.Id_Evento}</p>
                                <p><strong>Entradas Vendidas:</strong> ${eventStat.EntradasVendidas}</p>
                                <p><strong>Ganancia Total:</strong> S/. ${parseFloat(eventStat.GananciaTotal).toFixed(2)}</p>
                                <!-- Asistentes Confirmados no está disponible en la API actual, puedes omitirlo o añadirlo si lo implementas -->
                                <!-- <p><strong>Asistentes Confirmados:</strong> N/A</p> -->
                            </div>
                        `;
                    });
                } else {
                    htmlContent += '<p>No hay estadísticas detalladas por evento disponibles aún (quizás porque no hay ventas).</p>';
                }
                statsList.innerHTML = htmlContent;
            }

            fetchStats(); // Cargar estadísticas al cargar la página
        });
    </script>
</body>
</html>
