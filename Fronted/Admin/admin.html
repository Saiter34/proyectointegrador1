<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - TEYCKETAN</title>
    <!-- CSS en un archivo separado con nombre específico -->
    <link rel="stylesheet" href="admin.css"> 
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>

    <!-- SIDEBAR -->
    <div class="admin-sidebar">
        <div class="admin-barra-logo">
            <!-- RUTA CORREGIDA: Acceso absoluto desde la raíz del servidor estático -->
            <img src="../img/logo.png" alt="Logo Teycketan" class="admin-logo-img" />
        </div>
        <ul class="admin-nav-list">
            <li><a href="admin.html" class="admin-nav-item active"><i class="fas fa-home"></i><span>Bienvenido</span></a></li>
            <li><a href="solicitud.html" class="admin-nav-item"><i class="fas fa-user-clock"></i><span>Solicitud de proveedores</span></a></li>
            <li><a href="aprobados.html" class="admin-nav-item"><i class="fas fa-user-check"></i><span>Proveedores aprobados</span></a></li>
            <li><a href="eventos.html" class="admin-nav-item"><i class="fas fa-tasks"></i><span>Solicitud de eventos</span></a></li>
            <li><a href="eventoApro.html" class="admin-nav-item"><i class="fas fa-check-circle"></i><span>Eventos aprobados</span></a></li>
            <li><a href="categorias.html" class="admin-nav-item"><i class="fas fa-tags"></i><span>Eventos por categorias</span></a></li>
            <li><a href="eventoDestacado.html" class="admin-nav-item"><i class="fas fa-star"></i><span>Eventos Destacados</span></a></li>
            <li><a href="solicitudDestacar.html" class="admin-nav-item"><i class="fas fa-inbox"></i><span>Solicitudes para destacar</span></a></li>
            <li><a href="catalogoDeLugares.html" class="admin-nav-item"><i  class="fas fa-map-marker-alt"></i><span>Catalogo de lugares</span></a></li>
            <li><a href="reclamos.html" class="admin-nav-item"><i  class="fas fa-envelope"></i><span>Reclamos</span></a></li>
            <li><a href="comentariosClientes.html" class="admin-nav-item"><i class="fas fa-person"></i><span>Comentarios del cliente</span></a></li>

        </ul>
    </div>

    <!-- MAIN CONTENT -->
    <div class="admin-main-content">
        <header class="admin-topbar">
            <h1 class="admin-titulo-seccion">Bienvenido al panel de administrador</h1>
            <div class="admin-acciones">
                <div class="admin-notif-wrapper">
                    <button class="admin-notif-btn" id="adminNotifToggle">
                        <i class="fas fa-bell"></i>
                        <span class="admin-notif-dot"></span>
                    </button>
                    <div class="admin-notif-dropdown" id="adminNotifDropdown">
                        <p class="admin-notif-title">Notificaciones</p>
                        <ul>
                            <li>Evento “Damiano David” fue aprobado</li>
                            <li>Nuevo mensaje del soporte</li>
                            <li>Revisa los detalles del evento</li>
                        </ul>
                    </div>
                </div>
                <button id="adminLogoutButton" class="admin-btn-logout">Cerrar Sesión</button>
            </div>
        </header>

        <section class="admin-contenido">
            <div class="admin-bienvenida">Bienvenido al panel de administración. Aquí puedes gestionar proveedores y eventos.</div>
            <!-- Aquí irá el contenido específico de cada sección que cambie dinámicamente -->
             <section class="prov-contenido">
                <div class="prov-info-cards-grid">
                    <div class="prov-info-card">
                        <h4>Comentarios de clientes pendientes</h4>
                        <p id="pendingEventsCount">0</p>
                        <small>Comentarios esperando aprovacion.</small>
                    </div>
                    <div class="prov-info-card">
                        <h4>Solicitudes de proveedores</h4>
                        <p id="approvedEventsCount">0</p>
                        <small>Clientes esperando respuesta para cambiar de rol.</small>
                    </div>
                    <div class="prov-info-card">
                        <h4>Eventos pendientes</h4>
                        <p id="rejectedEventsCount">0</p>
                        <small>Eventos que necesitan ser aporvados o rechazados.</small>
                    </div>
                </div>

                <!-- Botones para acceder a Editar Datos y Reporte de Ventas dentro de la sección de bienvenida -->
                <div style="display: flex; justify-content: center; gap: 20px; margin-top: 30px;">
                    <button class="prov-btn-submit" id="showEditProfileBtn" style="background-color: #007bff;"><i class="fas fa-user-edit"></i> Editar Datos</button>
                    <button class="prov-btn-submit" id="showSalesReportBtn" style="background-color: #28a745;"><i class="fas fa-chart-line"></i> Reporte de Ventas</button>
                </div>

                <!-- Sección de Editar Datos (inicialmente oculta) -->
                <div id="edit-profile-section" class="prov-section" style="display: none; margin-top: 30px;">
                    <h3>Editar Datos de Perfil</h3>
                    <form id="editProfileForm" class="prov-form">
                        <div class="form-group">
                            <label for="profileName">Nombre:</label>
                            <input type="text" id="profileName" name="Nom_Usuario" required>
                        </div>
                        <div class="form-group">
                            <label for="profileApellido">Apellido:</label>
                            <input type="text" id="profileApellido" name="Ape_Usuario" required>
                        </div>
                        <div class="form-group">
                            <label for="profileEmail">Email:</label>
                            <input type="email" id="profileEmail" name="Correo_Usuario" required readonly>
                        </div>
                        <div class="form-group">
                            <label for="profilePhone">Teléfono:</label>
                            <input type="tel" id="profilePhone" name="Tlf_Usuario">
                        </div>
                        <div class="form-group">
                            <label for="profileOldPassword">Contraseña Antigua (opcional):</label>
                            <input type="password" id="profileOldPassword" name="oldPassword">
                        </div>
                        <div class="form-group">
                            <label for="profileNewPassword">Nueva Contraseña (opcional):</label>
                            <input type="password" id="profileNewPassword" name="newPassword">
                        </div>
                        <div class="form-group">
                            <label for="profileConfirmNewPassword">Confirmar Nueva Contraseña:</label>
                            <input type="password" id="profileConfirmNewPassword" name="confirmNewPassword">
                        </div>
                        <button type="submit" class="prov-btn-submit">Guardar Cambios</button>
                        <button type="button" class="prov-btn-cancel" id="cancelEditProfile">Cancelar</button>
                    </form>
                </div>

                <!-- Sección de Reporte de Ventas (inicialmente oculta) -->
                <div id="sales-report-section" class="prov-section" style="display: none; margin-top: 30px;">
                    <h3>Reporte de Ventas</h3>
                    <div class="prov-info-cards-grid">
                        <div class="prov-info-card">
                            <h4>Total de Ventas Realizadas</h4>
                            <p id="totalSalesAmount">S/ 0.00</p>
                            <small>Monto total de tickets vendidos.</small>
                        </div>
                        <div class="prov-info-card">
                            <h4>Tickets Vendidos</h4>
                            <p id="totalTicketsSold">0</p>
                            <small>Cantidad total de tickets vendidos.</small>
                        </div>
                        <div class="prov-info-card">
                            <h4>Eventos con Ventas</h4>
                            <p id="eventsWithSales">0</p>
                            <small>Número de eventos con al menos una venta.</small>
                        </div>
                        <!-- Gráficos o tablas adicionales se pueden agregar aquí -->
                    </div>
                </div>

            </div>

            <!-- Contenedor para mensajes (para modales) -->
            <div id="provMessageContainer" class="prov-message-container"></div>
        </section>
        </section>
    </div>

    <!-- Modales para Admin Panel -->
    <div id="adminConfirmationModal" class="admin-modal">
        <div class="admin-modal-content">
            <span class="admin-close-button">&times;</span>
            <p id="adminModalMessage">¿Estás seguro de realizar esta acción?</p>
            <button id="adminModalConfirmBtn" class="admin-modal-btn admin-modal-confirm">Confirmar</button>
            <button id="adminModalCancelBtn" class="admin-modal-btn admin-modal-cancel">Cancelar</button>
        </div>
    </div>

    <div id="adminMessageModal" class="admin-modal">
        <div class="admin-modal-content">
            <span class="admin-close-button">&times;</span>
            <p id="adminMessageModalText"></p>
            <button id="adminMessageModalCloseBtn" class="admin-modal-btn admin-modal-confirm">Aceptar</button>
        </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
            const adminLogoutButton = document.getElementById('adminLogoutButton');
            const adminNotifToggle = document.getElementById('adminNotifToggle');
            const adminNotifDropdown = document.getElementById('adminNotifDropdown');

            // Referencias a los nuevos IDs de modales
            const adminConfirmationModal = document.getElementById('adminConfirmationModal');
            const adminModalMessage = document.getElementById('adminModalMessage');
            const adminModalConfirmBtn = document.getElementById('adminModalConfirmBtn');
            const adminModalCancelBtn = document.getElementById('adminModalCancelBtn');
            const adminMessageModal = document.getElementById('adminMessageModal');
            const adminMessageModalText = document.getElementById('adminMessageModalText');
            const adminMessageModalCloseBtn = document.getElementById('adminMessageModalCloseBtn');

            /**
             * @brief Muestra un modal de confirmación al usuario (específico para Admin).
             * @param {string} message - El mensaje a mostrar en el modal.
             * @returns {Promise<boolean>} Una promesa que se resuelve a `true` si el usuario confirma, `false` si cancela.
             */
           function showAdminConfirmationModal(message) {
                return new Promise((resolve) => {
                    adminModalMessage.textContent = message;
                    adminConfirmationModal.style.display = 'flex'; // Usar flex para centrar
                    
                    const confirmHandler = () => {
                        adminConfirmationModal.style.display = 'none';
                        adminModalConfirmBtn.removeEventListener('click', confirmHandler);
                        adminModalCancelBtn.removeEventListener('click', cancelHandler);
                        adminConfirmationModal.querySelector('.admin-close-button').removeEventListener('click', cancelHandler);
                        resolve(true);
                    };

                    const cancelHandler = () => {
                        adminConfirmationModal.style.display = 'none';
                        adminModalConfirmBtn.removeEventListener('click', confirmHandler);
                        adminModalCancelBtn.removeEventListener('click', cancelHandler);
                        adminConfirmationModal.querySelector('.admin-close-button').removeEventListener('click', cancelHandler);
                        resolve(false);
                    };

                    adminModalConfirmBtn.addEventListener('click', confirmHandler);
                    adminModalCancelBtn.addEventListener('click', cancelHandler);
                    adminConfirmationModal.querySelector('.admin-close-button').addEventListener('click', cancelHandler);
                });
            }

            /**
             * @brief Muestra un modal de mensaje informativo al usuario (específico para Admin).
             * @param {string} message - El mensaje a mostrar en el modal.
             */
            function showAdminMessageModal(message) {
                adminMessageModalText.textContent = message;
                adminMessageModal.style.display = 'flex'; // Usar flex para centrar
                adminMessageModalCloseBtn.onclick = () => {
                    adminMessageModal.style.display = 'none';
                };
                adminMessageModal.querySelector('.admin-close-button').onclick = () => {
                    adminMessageModal.style.display = 'none';
                };
            }

            // --- Lógica de Autenticación al cargar la página ---
            const token = localStorage.getItem('jwtToken');
            const userRole = localStorage.getItem('userRole');

            console.log('Admin Panel Loaded.'); 
            console.log('JWT Token:', token ? 'Exists' : 'Missing'); 
            console.log('User Role from localStorage:', userRole); 

            // Seguridad: Redirige si no hay token o el rol no es 'admin'
            if (!token || userRole !== 'admin') {
                showAdminMessageModal('Acceso denegado. Debes ser un administrador para ver esta página.'); 
                setTimeout(() => {
                    // Redirige al login.html (un nivel arriba de Admin/)
                    window.location.replace('../login.html'); 
                }, 2000); // Dar 2 segundos para leer el mensaje
                return; // Detiene la ejecución del script
            }
            // --- Event Listener para Cerrar Sesión ---
            adminLogoutButton.addEventListener('click', async () => {
                const confirmLogout = await showAdminConfirmationModal('¿Estás seguro de que quieres cerrar sesión?');
                if (confirmLogout) {
                    localStorage.removeItem('jwtToken');
                    localStorage.removeItem('userName');
                    localStorage.removeItem('userRole');
                    localStorage.removeItem('isOrganizer');
                    localStorage.removeItem('userId'); // Limpia también el userId si lo estás guardando
                    showAdminMessageModal('Sesión cerrada correctamente.');
                    setTimeout(() => {
                        window.location.replace('../login.html'); // Redirige al login.html
                    }, 500); 
                }
            });

            // --- Lógica para Notificaciones (Dropdown) ---
            adminNotifToggle.addEventListener('click', (event) => {
                event.stopPropagation(); // Evita que el clic se propague al documento
                adminNotifDropdown.style.display = adminNotifDropdown.style.display === 'block' ? 'none' : 'block';
            });

            // Cierra el dropdown si se hace clic fuera de él
            document.addEventListener('click', (event) => {
                if (!adminNotifDropdown.contains(event.target) && !adminNotifToggle.contains(event.target)) {
                    adminNotifDropdown.style.display = 'none';
                }
            });

            // Añadir clase 'active' al enlace de la página actual
            const currentPath = window.location.pathname;
            document.querySelectorAll('.admin-nav-item').forEach(link => {
                if (link.href.includes(currentPath)) {
                    link.classList.add('active');
                }
            });
        });
    </script>
</body>
</html>
