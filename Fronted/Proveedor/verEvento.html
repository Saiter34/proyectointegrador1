<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ver Eventos - TEYCKETAN</title>
    <!-- Enlace al archivo CSS externo -->
    <link rel="stylesheet" href="proveedor.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>

    <!-- SIDEBAR -->
    <div class="prov-sidebar">
        <div class="prov-barra-logo">
            <img src="../img/logo.png" alt="Logo Teycketan" class="prov-logo-img" />
        </div>
        <ul class="prov-nav-list">
            <li><a href="proveedorPanel.html" class="prov-nav-item"><i class="fas fa-home"></i><span>Bienvenido</span></a></li>
            <li><a href="crearevento.html" class="prov-nav-item"><i class="fas fa-plus-circle"></i><span>Crear evento</span></a></li>
            <li><a href="verEvento.html" class="prov-nav-item active"><i class="fas fa-calendar-alt"></i><span>Ver eventos</span></a></li>
            <li><a href="contactarEmpresa.html" class="prov-nav-item"><i class="fas fa-envelope"></i><span>Contactar empresa</span></a></li>
            <li><a href="eventosAprov.html" class="prov-nav-item"><i class="fas fa-check-circle"></i><span>Eventos Aprobados</span></a></li>
            <li><a href="catalogoDeLugares.html" class="prov-nav-item"><i class="fas fa-map-marker-alt"></i><span>Catalogo de lugares</span></a></li>
        </ul>
    </div>

    <!-- MAIN CONTENT -->
    <div class="prov-main-content">
        <header class="prov-topbar">
            <h1 class="prov-titulo-seccion">Ver eventos - Panel del administrador</h1>
            <div class="prov-acciones">
                <div class="prov-notif-wrapper">
                    <button class="prov-notif-btn" id="provNotifToggle">
                        <i class="fas fa-bell"></i>
                        <span class="prov-notif-dot" id="notifDot" style="display:none;"></span>
                    </button>
                    <div class="prov-notif-dropdown" id="provNotifDropdown">
                        <p class="prov-notif-title">Notificaciones</p>
                        <ul id="notifList">
                            <!-- Las notificaciones se cargarán aquí dinámicamente -->
                        </ul>
                        <button id="markAllReadBtn" style="width: 100%; padding: 10px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">Marcar todas como leídas</button>
                    </div>
                </div>
                <a href="crearevento.html" class="prov-btn-crear-evento">+ Nuevo evento</a>
                <button id="provLogoutButton" class="prov-btn-logout">Cerrar Sesión</button>
            </div>
        </header>

        <section class="prov-contenido">
            <div class="prov-bienvenida">Aquí puedes ver todos los eventos que has creado y gestionar su estado.</div>

            <!-- Contenedor para mensajes (para modales) -->
            <div id="provMessageContainer" class="prov-message-container"></div>

            <div class="prov-tabla-contenedor">
                <table class="prov-table">
                    <thead>
                        <tr>
                            <th>Imagen</th>
                            <th>Nombre del Evento</th>
                            <th>Fecha</th>
                            <th>Horario</th>
                            <th>Lugar</th>
                            <th>Ubicación del Lugar</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="eventsListBody">
                        <!-- Los eventos se cargarán aquí dinámicamente -->
                        <tr><td colspan="8" class="prov-loading-message">Cargando tus eventos...</td></tr>
                    </tbody>
                </table>
                <p id="noEventsMessage" class="prov-no-data-message" style="display: none;">No has creado ningún evento aún.</p>
            </div>
        </section>
    </div>

    <!-- Modales -->
    <div id="provConfirmationModal" class="prov-modal">
        <div class="prov-modal-content">
            <span class="prov-close-button">&times;</span>
            <p id="provModalMessage">¿Estás seguro de realizar esta acción?</p>
            <button id="provModalConfirmBtn" class="prov-modal-btn prov-modal-confirm">Confirmar</button>
            <button id="provModalCancelBtn" class="prov-modal-btn prov-modal-cancel">Cancelar</button>
        </div>
    </div>

    <div id="provMessageModal" class="prov-modal">
        <div class="prov-modal-content">
            <span class="prov-close-button">&times;</span>
            <p id="provMessageModalText"></p>
            <button id="provMessageModalCloseBtn" class="prov-modal-btn prov-modal-confirm">Aceptar</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const API_URL = 'http://localhost:3000'; 

            // --- Lógica de Autenticación al cargar la página ---
            const token = localStorage.getItem('jwtToken');
            const userRole = localStorage.getItem('userRole');
            const userId = localStorage.getItem('userId');

            console.log('Ver Eventos Page Loaded.');
            console.log('JWT Token:', token ? 'Exists' : 'Missing');
            console.log('User Role from localStorage:', userRole);
            console.log('User ID from localStorage:', userId);

            // Seguridad: Redirige si no hay token o el rol no es 'organizador'
            if (!token || userRole !== 'organizador' || !userId) {
                showProvMessageModal('Acceso denegado. Debes ser un proveedor autenticado para ver esta página.', 'error');
                setTimeout(() => {
                    window.location.replace('../login.html');
                }, 2000);
                return;
            }

            // Elementos DOM principales
            const provLogoutButton = document.getElementById('provLogoutButton');
            const provNotifToggle = document.getElementById('provNotifToggle');
            const provNotifDropdown = document.getElementById('provNotifDropdown');
            const notifList = document.getElementById('notifList'); 
            const notifDot = document.getElementById('notifDot'); 
            const markAllReadBtn = document.getElementById('markAllReadBtn'); 
            const eventsListBody = document.getElementById('eventsListBody');
            const noEventsMessage = document.getElementById('noEventsMessage');

            // Referencias a los IDs de modales
            const provConfirmationModal = document.getElementById('provConfirmationModal');
            const provModalMessage = document.getElementById('provModalMessage');
            const provModalConfirmBtn = document.getElementById('provModalConfirmBtn');
            const provModalCancelBtn = document.getElementById('provModalCancelBtn');
            const provMessageModal = document.getElementById('provMessageModal');
            const provMessageModalText = document.getElementById('provMessageModalText');
            const provMessageModalCloseBtn = document.getElementById('provMessageModalCloseBtn');

            // Variable para almacenar la lista de lugares
            let availablePlaces = [];

            // --- Funciones para Modales ---
            function showProvConfirmationModal(message) {
                return new Promise((resolve) => {
                    provModalMessage.textContent = message;
                    provConfirmationModal.style.display = 'flex';

                    const confirmHandler = () => {
                        provConfirmationModal.style.display = 'none';
                        provModalConfirmBtn.removeEventListener('click', confirmHandler);
                        provModalCancelBtn.removeEventListener('click', cancelHandler);
                        provConfirmationModal.querySelector('.prov-close-button').removeEventListener('click', cancelHandler);
                        resolve(true);
                    };

                    const cancelHandler = () => {
                        provConfirmationModal.style.display = 'none';
                        provModalConfirmBtn.removeEventListener('click', confirmHandler);
                        provModalCancelBtn.removeEventListener('click', cancelHandler);
                        provConfirmationModal.querySelector('.prov-close-button').removeEventListener('click', cancelHandler);
                        resolve(false);
                    };

                    provModalConfirmBtn.addEventListener('click', confirmHandler);
                    provModalCancelBtn.addEventListener('click', cancelHandler);
                    provConfirmationModal.querySelector('.prov-close-button').addEventListener('click', cancelHandler);
                });
            }

            function showProvMessageModal(message, type = '') {
                provMessageModalText.textContent = message;
                provMessageModalText.className = `prov-message-text ${type ? 'prov-message-' + type : ''}`; 
                provMessageModal.style.display = 'flex';

                provMessageModalCloseBtn.onclick = () => {
                    provMessageModal.style.display = 'none';
                };
                provMessageModal.querySelector('.prov-close-button').onclick = () => {
                    provMessageModal.style.display = 'none';
                };
            }

            // --- Event Listener para Cerrar Sesión ---
            provLogoutButton.addEventListener('click', async () => {
                const confirmLogout = await showProvConfirmationModal('¿Estás seguro de que quieres cerrar sesión?');
                if (confirmLogout) {
                    localStorage.removeItem('jwtToken');
                    localStorage.removeItem('userName');
                    localStorage.removeItem('userRole');
                    localStorage.removeItem('isOrganizer');
                    localStorage.removeItem('userId');
                    showProvMessageModal('Sesión cerrada correctamente.', 'success');
                    setTimeout(() => {
                        window.location.replace('../login.html');
                    }, 500);
                }
            });

            // --- Lógica para Notificaciones (Dropdown) ---
            provNotifToggle.addEventListener('click', async (event) => {
                event.stopPropagation();
                if (provNotifDropdown.style.display === 'block') {
                    provNotifDropdown.style.display = 'none';
                } else {
                    provNotifDropdown.style.display = 'block';
                    await fetchNotifications(); // Cargar notificaciones cada vez que se abre
                }
            });

            document.addEventListener('click', (event) => {
                if (!provNotifDropdown.contains(event.target) && !provNotifToggle.contains(event.target)) {
                    provNotifDropdown.style.display = 'none';
                }
            });

            async function fetchNotifications() {
                try {
                    const response = await fetch(`${API_URL}/api/notificaciones/usuario/${userId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await response.json();

                    if (response.ok && data.notifications) {
                        notifList.innerHTML = ''; // Limpiar lista actual
                        let unreadCount = 0;
                        if (data.notifications.length > 0) {
                            data.notifications.forEach(notif => {
                                const listItem = document.createElement('li');
                                listItem.textContent = notif.Mensaje;
                                if (!notif.Leida) {
                                    listItem.classList.add('unread');
                                    unreadCount++;
                                }
                                listItem.dataset.notificationId = notif.Id_Notificacion;
                                listItem.addEventListener('click', () => markNotificationAsRead(notif.Id_Notificacion));
                                notifList.appendChild(listItem);
                            });
                        } else {
                            const listItem = document.createElement('li');
                            listItem.textContent = 'No tienes notificaciones nuevas.';
                            notifList.appendChild(listItem);
                        }

                        if (unreadCount > 0) {
                            notifDot.style.display = 'block';
                        } else {
                            notifDot.style.display = 'none';
                        }
                    } else {
                        showProvMessageModal(`Error al cargar notificaciones: ${data.message || 'Desconocido'}`, 'error');
                        notifDot.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Error al cargar notificaciones:', error);
                    showProvMessageModal('Error de red al cargar notificaciones.', 'error');
                    notifDot.style.display = 'none';
                }
            }

            async function markNotificationAsRead(notificationId) {
                try {
                    const response = await fetch(`${API_URL}/api/notificaciones/${notificationId}/mark-as-read`, { 
                        method: 'PUT',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        const listItem = notifList.querySelector(`li[data-notification-id="${notificationId}"]`);
                        if (listItem) {
                            listItem.classList.remove('unread');
                            const unreadItems = notifList.querySelectorAll('li.unread');
                            if (unreadItems.length === 0) {
                                notifDot.style.display = 'none';
                            }
                        }
                    } else {
                        const errorData = await response.json();
                        showProvMessageModal(`Error al marcar notificación: ${errorData.message || 'Desconocido'}`, 'error');
                    }
                } catch (error) {
                    console.error('Error al marcar notificación como leída:', error);
                    showProvMessageModal('Error de red al marcar notificación.', 'error');
                }
            }

            markAllReadBtn.addEventListener('click', async () => {
                const confirmRead = await showProvConfirmationModal('¿Estás seguro de que quieres marcar todas las notificaciones como leídas?');
                if (confirmRead) {
                    try {
                        const response = await fetch(`${API_URL}/api/notificaciones/marcarTodasLeidas/${userId}`, {
                            method: 'PUT',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (response.ok) {
                            showProvMessageModal('Todas las notificaciones han sido marcadas como leídas.', 'success');
                            fetchNotifications(); // Recargar para actualizar la UI
                        } else {
                            const errorData = await response.json();
                            showProvMessageModal(`Error al marcar todas como leídas: ${errorData.message || 'Desconocido'}`, 'error');
                        }
                    } catch (error) {
                        console.error('Error al marcar todas las notificaciones como leídas:', error);
                        showProvMessageModal('Error de red al marcar todas las notificaciones.', 'error');
                    }
                }
            });

            // Añadir clase 'active' al enlace de la página actual en el sidebar
            const currentPath = window.location.pathname;
            document.querySelectorAll('.prov-nav-item').forEach(link => {
                if (link.href.includes('verEvento.html')) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });

            // --- Funcionalidad para cargar y mostrar eventos del proveedor ---

            /**
             * @brief Carga todos los eventos creados por el proveedor autenticado.
             */
            async function fetchProviderEvents() {
                eventsListBody.innerHTML = '<tr><td colspan="8" class="prov-loading-message">Cargando tus eventos...</td></tr>';
                noEventsMessage.style.display = 'none';

                try {
                    const response = await fetch(`${API_URL}/api/proveedor/eventos`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const data = await response.json();

                    if (response.ok && data.events) {
                        if (data.events.length === 0) {
                            eventsListBody.innerHTML = '';
                            noEventsMessage.style.display = 'block';
                        } else {
                            renderEventsTable(data.events);
                        }
                    } else {
                        showProvMessageModal(`Error al cargar tus eventos: ${data.message || 'Desconocido'}`, 'error');
                        eventsListBody.innerHTML = `<tr><td colspan="8" class="prov-no-data-message prov-error-text">No se pudieron cargar tus eventos.</td></tr>`;
                    }
                } catch (error) {
                    console.error('Error al cargar eventos del proveedor:', error);
                    showProvMessageModal('Error de red al cargar tus eventos.', 'error');
                    eventsListBody.innerHTML = `<tr><td colspan="8" class="prov-no-data-message prov-error-text">Error de red.</td></tr>`;
                }
            }

            /**
             * @brief Renderiza la tabla de eventos del proveedor.
             * @param {Array<Object>} events - Array de objetos de evento.
             */
            function renderEventsTable(events) {
                eventsListBody.innerHTML = ''; // Limpiar tbody
                noEventsMessage.style.display = 'none';

                if (events.length === 0) {
                    noEventsMessage.style.display = 'block';
                    return;
                }

                let tableRowsHtml = '';
                events.forEach(event => {
                    const imageUrl = event.URL_Imagen_Evento ? `${API_URL}${event.URL_Imagen_Evento}` : 'https://placehold.co/60x60/cccccc/000000?text=No+Img';
                    
                    tableRowsHtml += `
                        <tr data-event-id="${event.Id_Evento}" class="event-main-row">
                            <td data-label="Imagen"><img src="${imageUrl}" alt="Imagen del evento" class="prov-event-image-thumbnail"></td>
                            <td data-label="Nombre">${event.Nom_Evento}</td>
                            <td data-label="Fecha">${new Date(event.Fecha).toLocaleDateString('es-ES')}</td>
                            <td data-label="Horario">${event.Horario_Inicio || 'N/A'} - ${event.Horario_Fin || 'N/A'}</td>
                            <td data-label="Lugar">${event.Nom_Lugar || 'N/A'}</td> 
                            <td data-label="Ubicación del Lugar">${event.Ubicacion_Lugar || 'N/A'}</td> 
                            <td data-label="Estado">
                                <span class="event-status event-status-${event.Estado.toLowerCase()}">${event.Estado}</span>
                            </td>
                            <td class="prov-actions-cell">
                                <button class="prov-btn-details" data-id="${event.Id_Evento}" data-name="${event.Nom_Evento}"><i class="fas fa-info-circle"></i> Detalles</button>
                                <button class="prov-btn-edit" data-id="${event.Id_Evento}" data-name="${event.Nom_Evento}"><i class="fas fa-edit"></i> Editar</button>
                                <button class="prov-btn-delete" data-id="${event.Id_Evento}" data-name="${event.Nom_Evento}"><i class="fas fa-trash-alt"></i> Eliminar</button>
                            </td>
                        </tr>
                        <tr class="prov-details-row" id="details-row-${event.Id_Evento}" style="display: none;">
                            <td colspan="8">
                                <div class="prov-details-content">
                                    <h3>Detalles y Estadísticas de Venta para "${event.Nom_Evento}"</h3>
                                    <p><strong>Categoría:</strong> ${event.Categoria || 'N/A'}</p>
                                    <p><strong>Descripción:</strong> ${event.Descripcion || 'N/A'}</p>
                                    <p><strong>Reglas:</strong> ${event.Reglas && event.Reglas.length > 0 ? event.Reglas.join(', ') : 'N/A'}</p>
                                    <p><strong>Solicitud Destacar:</strong> ${event.SolicitudDestacar ? 'Sí' : 'No'}</p>
                                    <hr class="catl-divider">
                                    <h4>Precios y Categorías de Entradas:</h4>
                                    <ul id="ticket-categories-${event.Id_Evento}">
                                        ${event.CategoriasDeEntradas && event.CategoriasDeEntradas.length > 0 ? 
                                            event.CategoriasDeEntradas.map(cat => {
                                                const precioPreventaCalculado = (cat.precioRegular * 0.80).toFixed(2); // 20% menos
                                                return `
                                                <li>
                                                    <strong>${cat.Nom_Categoria}:</strong> 
                                                    Precio Regular: S/. ${parseFloat(cat.precioRegular).toFixed(2)}, 
                                                    Precio Preventa: S/. ${precioPreventaCalculado}, 
                                                    Stock Disponible: ${cat.stockDisponible}
                                                </li>
                                                `;
                                            }).join('')
                                            : '<li>No hay categorías de entradas definidas.</li>'
                                        }
                                    </ul>
                                    <hr class="catl-divider">
                                    <h4>Tickets Vendidos:</h4>
                                    <!-- Si estas estadísticas muestran 'Cargando...' o '0', verifica el endpoint de tu backend:
                                         /api/proveedor/eventos/{eventId}/stats para asegurarte de que devuelve los datos correctos. -->
                                    <p><strong>General Vendidos:</strong> <span id="sold-general-${event.Id_Evento}">Cargando...</span></p>
                                    <p><strong>VIP Vendidos:</strong> <span id="sold-vip-${event.Id_Evento}">Cargando...</span></p>
                                    <p><strong>CONADIS Vendidos:</strong> <span id="sold-conadis-${event.Id_Evento}">Cargando...</span></p>
                                    <p><strong>Total Vendidos:</strong> <span id="sold-total-${event.Id_Evento}">Cargando...</span></p>
                                    <p><strong>Ganancias Estimadas:</strong> <span id="revenue-${event.Id_Evento}">Cargando...</span></p>
                                </div>
                            </td>
                        </tr>
                        <tr class="prov-edit-row" id="edit-row-${event.Id_Evento}" style="display: none;">
                            <td colspan="8">
                                <div class="prov-edit-form-content">
                                    <h3>Editar Evento "${event.Nom_Evento}"</h3>
                                    <form id="edit-form-${event.Id_Evento}">
                                        <div class="form-group">
                                            <label for="edit-name-${event.Id_Evento}">Nombre del Evento:</label>
                                            <input type="text" id="edit-name-${event.Id_Evento}" name="Nom_Evento" value="${event.Nom_Evento}" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="edit-date-${event.Id_Evento}">Fecha:</label>
                                            <input type="date" id="edit-date-${event.Id_Evento}" name="Fecha" value="${event.Fecha.split('T')[0]}" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="edit-start-time-${event.Id_Evento}">Hora Inicio:</label>
                                            <input type="time" id="edit-start-time-${event.Id_Evento}" name="Horario_Inicio" value="${event.Horario_Inicio || ''}" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="edit-end-time-${event.Id_Evento}">Hora Fin:</label>
                                            <input type="time" id="edit-end-time-${event.Id_Evento}" name="Horario_Fin" value="${event.Horario_Fin || ''}" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="edit-category-${event.Id_Evento}">Categoría:</label>
                                            <input type="text" id="edit-category-${event.Id_Evento}" name="Categoria" value="${event.Categoria || ''}" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="edit-description-${event.Id_Evento}">Descripción:</label>
                                            <textarea id="edit-description-${event.Id_Evento}" name="Descripcion" required>${event.Descripcion || ''}</textarea>
                                        </div>
                                        <div class="form-group">
                                            <label for="edit-place-${event.Id_Evento}">Lugar:</label>
                                            <select id="edit-place-${event.Id_Evento}" name="Id_Lugar" required>
                                                <!-- Opciones de lugares se cargarán aquí dinámicamente -->
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="edit-image-url-${event.Id_Evento}">URL Imagen Evento:</label>
                                            <input type="text" id="edit-image-url-${event.Id_Evento}" name="URL_Imagen_Evento" value="${event.URL_Imagen_Evento || ''}">
                                        </div>
                                        <div class="form-group">
                                            <label for="edit-rules-${event.Id_Evento}">Reglas (separadas por coma):</label>
                                            <input type="text" id="edit-rules-${event.Id_Evento}" name="Reglas" value="${event.Reglas ? event.Reglas.join(', ') : ''}">
                                        </div>
                                        <div class="prov-edit-form-actions">
                                            <button type="submit" class="prov-btn-save" data-id="${event.Id_Evento}"><i class="fas fa-save"></i> Guardar Cambios</button>
                                            <button type="button" class="prov-btn-cancel" data-id="${event.Id_Evento}"><i class="fas fa-times-circle"></i> Cancelar</button>
                                        </div>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                eventsListBody.innerHTML = tableRowsHtml;

                // Añadir event listeners a los botones de acción
                eventsListBody.querySelectorAll('.prov-btn-details').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const eventId = e.target.dataset.id || e.target.closest('button').dataset.id;
                        toggleEventDetails(eventId);
                    });
                });
                eventsListBody.querySelectorAll('.prov-btn-edit').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const eventId = e.target.dataset.id || e.target.closest('button').dataset.id;
                        await toggleEditForm(eventId);
                    });
                });
                eventsListBody.querySelectorAll('.prov-btn-delete').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const eventId = e.target.dataset.id || e.target.closest('button').dataset.id;
                        const eventName = e.target.dataset.name || e.target.closest('button').dataset.name;
                        handleDeleteEvent(eventId, eventName);
                    });
                });

                // Añadir listeners para los formularios de edición (después de que se rendericen)
                events.forEach(event => {
                    const editForm = document.getElementById(`edit-form-${event.Id_Evento}`);
                    if (editForm) {
                        editForm.addEventListener('submit', (e) => {
                            e.preventDefault();
                            handleEditSubmit(event.Id_Evento);
                        });
                        editForm.querySelector('.prov-btn-cancel').addEventListener('click', () => {
                            toggleEditForm(event.Id_Evento); // Oculta el formulario
                        });
                    }
                });
            }

            /**
             * @brief Alterna la visibilidad de los detalles del evento y carga las estadísticas.
             * @param {number} eventId - El ID del evento cuyos detalles se van a mostrar/ocultar.
             */
            async function toggleEventDetails(eventId) {
                const detailsRow = document.getElementById(`details-row-${eventId}`);
                const editRow = document.getElementById(`edit-row-${eventId}`); // Obtener la fila de edición

                // Ocultar cualquier otra fila de detalles o edición que pueda estar abierta
                document.querySelectorAll('.prov-details-row, .prov-edit-row').forEach(row => {
                    if (row.id !== `details-row-${eventId}` && row.id !== `edit-row-${eventId}` && row.style.display !== 'none') {
                        row.style.display = 'none';
                        row.classList.remove('show-details');
                        row.classList.remove('show-edit');
                    }
                });

                if (detailsRow.style.display === 'none') {
                    detailsRow.style.display = 'table-row';
                    detailsRow.classList.add('show-details');
                    await fetchEventStatistics(eventId); // Cargar estadísticas cuando se muestra
                } else {
                    detailsRow.classList.remove('show-details');
                    detailsRow.style.display = 'none';
                }

                // Asegurarse de que la fila de edición esté oculta si se abren los detalles
                if (editRow) {
                    editRow.style.display = 'none';
                    editRow.classList.remove('show-edit');
                }
            }

            /**
             * @brief Alterna la visibilidad del formulario de edición y carga los datos del evento.
             * @param {number} eventId - El ID del evento a editar.
             */
            async function toggleEditForm(eventId) {
                const editRow = document.getElementById(`edit-row-${eventId}`);
                const detailsRow = document.getElementById(`details-row-${eventId}`); // Obtener la fila de detalles

                // Ocultar cualquier otra fila de detalles o edición que pueda estar abierta
                document.querySelectorAll('.prov-details-row, .prov-edit-row').forEach(row => {
                    if (row.id !== `edit-row-${eventId}` && row.id !== `details-row-${eventId}` && row.style.display !== 'none') {
                        row.style.display = 'none';
                        row.classList.remove('show-details');
                        row.classList.remove('show-edit');
                    }
                });

                if (editRow.style.display === 'none') {
                    editRow.style.display = 'table-row';
                    editRow.classList.add('show-edit'); // Clase para animación/estilo de edición
                    await loadEventForEdit(eventId); // Cargar datos para el formulario
                } else {
                    editRow.classList.remove('show-edit');
                    editRow.style.display = 'none';
                }

                // Asegurarse de que la fila de detalles esté oculta si se abre la edición
                if (detailsRow) {
                    detailsRow.style.display = 'none';
                    detailsRow.classList.remove('show-details');
                }
            }

            /**
             * @brief Carga los datos de un evento específico en el formulario de edición.
             * @param {number} eventId - El ID del evento a cargar.
             */
            async function loadEventForEdit(eventId) {
                try {
                    const response = await fetch(`${API_URL}/api/proveedor/eventos/${eventId}`, {
                        method: 'GET',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await response.json();

                    if (response.ok && data) {
                        const event = data;
                        document.getElementById(`edit-name-${eventId}`).value = event.Nom_Evento || '';
                        document.getElementById(`edit-date-${eventId}`).value = event.Fecha ? event.Fecha.split('T')[0] : '';
                        document.getElementById(`edit-start-time-${eventId}`).value = event.Horario_Inicio || '';
                        document.getElementById(`edit-end-time-${eventId}`).value = event.Horario_Fin || '';
                        document.getElementById(`edit-category-${eventId}`).value = event.Categoria || '';
                        document.getElementById(`edit-description-${eventId}`).value = event.Descripcion || '';
                        document.getElementById(`edit-image-url-${eventId}`).value = event.URL_Imagen_Evento || '';
                        document.getElementById(`edit-rules-${eventId}`).value = event.Reglas ? event.Reglas.join(', ') : '';

                        // Cargar lugares en el select
                        const placeSelect = document.getElementById(`edit-place-${eventId}`);
                        placeSelect.innerHTML = ''; // Limpiar opciones anteriores
                        if (availablePlaces.length === 0) {
                            await fetchAvailablePlaces(); // Cargar lugares si no están cargados
                        }
                        
                        availablePlaces.forEach(place => {
                            const option = document.createElement('option');
                            option.value = place.Id_Lugar;
                            option.textContent = `${place.Nom_Lugar} (${place.Ubicacion_Lugar})`;
                            if (place.Id_Lugar === event.Id_Lugar) { // Asumiendo que el evento tiene un Id_Lugar
                                option.selected = true;
                            }
                            placeSelect.appendChild(option);
                        });

                    } else {
                        showProvMessageModal(`Error al cargar datos del evento para edición: ${data.message || 'Desconocido'}`, 'error');
                        toggleEditForm(eventId); // Ocultar el formulario si hay un error
                    }
                } catch (error) {
                    console.error('Error al cargar datos del evento para edición:', error);
                    showProvMessageModal('Error de red al cargar datos del evento para edición.', 'error');
                    toggleEditForm(eventId); // Ocultar el formulario si hay un error
                }
            }

            /**
             * @brief Envía los datos actualizados del evento al backend.
             * @param {number} eventId - El ID del evento a actualizar.
             */
            async function handleEditSubmit(eventId) {
                const form = document.getElementById(`edit-form-${eventId}`);
                const formData = new FormData(form);
                const updatedData = {};

                for (let [key, value] of formData.entries()) {
                    if (key === 'Reglas') {
                        updatedData[key] = value.split(',').map(item => item.trim()).filter(item => item !== '');
                    } else if (key === 'Id_Lugar') {
                        updatedData[key] = parseInt(value); // Convertir a número
                    } else {
                        updatedData[key] = value;
                    }
                }

                showProvMessageModal('Guardando cambios del evento...', 'info');

                try {
                    const response = await fetch(`${API_URL}/api/proveedor/eventos/${eventId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(updatedData)
                    });
                    const data = await response.json();

                    if (response.ok) {
                        showProvMessageModal(data.message, 'success');
                        toggleEditForm(eventId); // Ocultar el formulario
                        fetchProviderEvents(); // Recargar la tabla para ver los cambios
                    } else {
                        showProvMessageModal(`Error al guardar cambios: ${data.message || 'Desconocido'}`, 'error');
                    }
                } catch (error) {
                    console.error('Error al guardar cambios del evento:', error);
                    showProvMessageModal('Error de red al guardar cambios del evento.', 'error');
                }
            }

            /**
             * @brief Carga y muestra las estadísticas de venta para un evento específico.
             * @param {number} eventId - El ID del evento para el que se cargarán las estadísticas.
             */
            async function fetchEventStatistics(eventId) {
                document.getElementById(`sold-general-${eventId}`).textContent = 'Cargando...';
                document.getElementById(`sold-vip-${eventId}`).textContent = 'Cargando...';
                document.getElementById(`sold-conadis-${eventId}`).textContent = 'Cargando...';
                document.getElementById(`sold-total-${eventId}`).textContent = 'Cargando...';
                document.getElementById(`revenue-${eventId}`).textContent = 'Cargando...';

                try {
                    const response = await fetch(`${API_URL}/api/proveedor/eventos/${eventId}/stats`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const data = await response.json();

                    if (response.ok && data.statistics) {
                        const stats = data.statistics;
                        document.getElementById(`sold-general-${eventId}`).textContent = stats.general_vendidos || 0;
                        document.getElementById(`sold-vip-${eventId}`).textContent = stats.vip_vendidos || 0;
                        document.getElementById(`sold-conadis-${eventId}`).textContent = stats.conadis_vendidos || 0;
                        document.getElementById(`sold-total-${eventId}`).textContent = stats.total_vendidos || 0;
                        document.getElementById(`revenue-${eventId}`).textContent = `S/. ${parseFloat(stats.ganancias_estimadas || 0).toFixed(2)}`;
                    } else {
                        // Si el backend no devuelve estadísticas o hay un error, lo indicamos.
                        throw new Error(data.message || 'Error al obtener estadísticas del evento.');
                    }
                } catch (error) {
                    console.error(`Error al cargar estadísticas para el evento ${eventId}:`, error);
                    document.getElementById(`sold-general-${eventId}`).textContent = 'Error';
                    document.getElementById(`sold-vip-${eventId}`).textContent = 'Error';
                    document.getElementById(`sold-conadis-${eventId}`).textContent = 'Error';
                    document.getElementById(`sold-total-${eventId}`).textContent = 'Error';
                    document.getElementById(`revenue-${eventId}`).textContent = 'Error';
                    showProvMessageModal(`No se pudieron cargar las estadísticas para el evento (ID: ${eventId}).`, 'error');
                }
            }

            /**
             * @brief Maneja la eliminación de un evento.
             * @param {number} eventId - El ID del evento a eliminar.
             * @param {string} eventName - El nombre del evento para el mensaje de confirmación.
             */
            async function handleDeleteEvent(eventId, eventName) {
                const confirmDelete = await showProvConfirmationModal(`¿Estás seguro de que quieres ELIMINAR el evento "${eventName}" (ID: ${eventId})? Esta acción no se puede deshacer.`);

                if (!confirmDelete) {
                    return;
                }

                showProvMessageModal('Eliminando evento...', 'info');

                try {
                    const response = await fetch(`${API_URL}/api/proveedor/eventos/${eventId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showProvMessageModal(data.message, 'success');
                        fetchProviderEvents(); // Recargar datos después de la eliminación
                    } else {
                        showProvMessageModal(`Error al eliminar el evento: ${data.message || data.error || 'Error desconocido'}`, 'error');
                    }
                } catch (error) {
                    console.error(`Error al eliminar el evento:`, error);
                    showProvMessageModal(`Error de conexión con el servidor al eliminar evento.`, 'error');
                }
            }

            /**
             * @brief Carga la lista de lugares disponibles.
             */
            async function fetchAvailablePlaces() {
                try {
                    // Tu endpoint de lugares ya está configurado para devolver un array de objetos de lugar directamente.
                    // No necesita un prefijo como '/api/lugares' si ya está montado así en index.js.
                    // Si en index.js tienes app.use('/api/lugares', lugaresRoutes);
                    // entonces la URL aquí debe ser `${API_URL}/api/lugares`
                    const response = await fetch(`${API_URL}/api/lugares`, { 
                        method: 'GET',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    // Tu backend devuelve un array directamente, no un objeto con una propiedad 'lugares'
                    const data = await response.json(); 
                    if (response.ok) {
                        availablePlaces = data; // Asignar directamente el array de lugares
                    } else {
                        console.error('Error al cargar lugares:', data.message || 'Desconocido');
                        showProvMessageModal('Error al cargar la lista de lugares disponibles.', 'error');
                    }
                } catch (error) {
                    console.error('Error de red al cargar lugares:', error);
                    showProvMessageModal('Error de red al cargar la lista de lugares disponibles.', 'error');
                }
            }

            // Llamar a la función para cargar lugares al inicio
            await fetchAvailablePlaces();
            // Llamar a la función para cargar eventos al cargar la página
            fetchProviderEvents();
            fetchNotifications(); // Cargar notificaciones al inicio
        });
    </script>
</body>
</html>
