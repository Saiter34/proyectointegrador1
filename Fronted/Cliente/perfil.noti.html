<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Perfil - Teycketan</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="perfil.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
    <!-- Fondos -->
    <div class="fondo-overlay-extra"></div>
    <div class="fondo-overlay"></div>

    <!-- Header -->
    
    <header class="encabezado">
<div class="logo">
  <a href="cliente.html">
    <img src="../img/logo.png" alt="Logo de Teycketan">
  </a>
</div>
      <nav>
          <div class="nav-box" id="organizerLinkContainer">
              <a href="../Proveedor/bienvenidoprov.html" id="organizerLink">¿Quieres ser organizador?</a>
          </div>

          <div class="nav-box dropdown">
              <button>Categorías</button>
              <div class="dropdown-content">
                  <!-- Nombres de categorías ajustados según tu posible backend -->
                  <a href="categorias.html?categoria=Conciertos">Conciertos</a>
                  <a href="categorias.html?categoria=Teatro">Teatro</a>
                  <a href="categorias.html?categoria=Deportiva">Deportes</a> 
                  <!-- Agrega más categorías aquí si existen en tu backend -->
              </div>
          </div>

          <div class="nav-box dropdown" id="miCuentaContainer">
              <button id="miCuentaButton">Mi Cuenta</button>
              <div class="dropdown-content" id="miCuentaDropdownContent">
                  <a href="perfil.html" id="viewProfileLink">Ver Perfil</a> <!-- Enlace directo a perfil.html -->
                  <a href="#" id="logoutLink">Cerrar Sesión</a>
              </div>
          </div>
        </nav>
  </header>

    <!-- Contenido principal -->
<div class="perfil-dashboard">
  <!-- Menú lateral izquierdo -->
  <aside class="perfil-sidebar">
    <div class="perfil-foto-box">
      <img src="../img/imagen.jpg" alt="Foto de perfil" />
    </div>
    <h3 id="userNameDisplay">Cargando...</h3>
    <span id="userRoleDisplay" class="perfil-rol">Cargando...</span>

  <nav class="perfil-menu">
      <a href="perfil.html">Datos Personales</a>
      <a href="perfilPuntos.html">Puntos Teycketan</a>
      <a href="perfilHistorial.html">Historial de Compras</a>
      <a href="perfil.noti.html" class="active">Notificaiones</a>
    </nav>
  </aside>

  <!-- Panel derecho principal -->
<section class="perfil-panel">
  <div class="perfil-box">
    <h2>Notificaciones</h2>

    <!-- Notificación individual -->
    <div class="notificacion-box">
      <div class="notificacion-info">
        <p class="notificacion-mensaje">
          <strong>Titulos en negrita</strong> demas normal.
        </p>
        <span class="notificacion-fecha">fecha</span>
      </div>
      <div class="notificacion-acciones">
        <button class="btn-ver-detalles" onclick="toggleDetalles(this)">
          <i class="fas fa-eye"></i> Ver detalles
        </button>
        <button class="btn-marcar-leido" onclick="marcarLeido(this)">
          <i class="fas fa-check"></i> Marcar como leído
        </button>
      </div>
      <div class="notificacion-detalles oculto">
        <p>Detalles de notificacion</p>
      </div>
    </div>

    <!-- Otra notificación -->
    <div class="notificacion-box">
      <div class="notificacion-info">
        <p class="notificacion-mensaje">
          <strong>Titulos en negrita</strong> demas normal.
        </p>
        <span class="notificacion-fecha">fecha</span>
      </div>
      <div class="notificacion-acciones">
        <button class="btn-ver-detalles" onclick="toggleDetalles(this)">
          <i class="fas fa-eye"></i> Ver detalles
        </button>
        <button class="btn-marcar-leido" onclick="marcarLeido(this)">
          <i class="fas fa-check"></i> Marcar como leído
        </button>
      </div>
      <div class="notificacion-detalles oculto">
        <p>Detalles de notificacion</p>
      </div>
    </div>

  </div>
</section>


</div>


    <footer>
        <img src="../img/logo.png" alt="Logo Footer" class="logo-footer" />
    </footer>

    <!-- Custom Modal for Alerts/Confirmations (copiado de cliente.html para consistencia) -->
    <div id="clientModal" class="client-modal">
        <div class="client-modal-content">
            <span class="client-close-button">&times;</span>
            <p id="clientModalMessage" class="client-message-text"></p>
            <div id="clientModalActions">
                <!-- Buttons are added here dynamically -->
            </div>
        </div>
    </div>
<script>
  function toggleDetalles(btn) {
    const box = btn.closest('.notificacion-box');
    const detalles = box.querySelector('.notificacion-detalles');
    detalles.classList.toggle('oculto');
    detalles.style.display = detalles.classList.contains('oculto') ? 'none' : 'block';

    // Cambiar texto del botón
    btn.innerHTML = detalles.classList.contains('oculto')
      ? '<i class="fas fa-eye"></i> Ver detalles'
      : '<i class="fas fa-eye-slash"></i> Ocultar detalles';
  }

  function marcarLeido(btn) {
    const box = btn.closest('.notificacion-box');
    box.classList.add('leido');
    btn.disabled = true;
    btn.textContent = 'Leído';
  }
</script>

    <script>
        const API_URL = 'http://localhost:3000'; // Asegúrate de que esta URL sea correcta para tu backend

        document.addEventListener('DOMContentLoaded', () => {
            // Referencias a elementos del DOM
            const userNameDisplay = document.getElementById('userNameDisplay');
            const userEmailDisplay = document.getElementById('userEmailDisplay');
            const userRoleDisplay = document.getElementById('userRoleDisplay');
            const userPointsDisplay = document.getElementById('userPointsDisplay');
            const userPointsEquivalent = document.getElementById('userPointsEquivalent');
            const historialComprasBody = document.getElementById('historialComprasBody');
            const noPurchasesMessage = document.getElementById('noPurchasesMessage');
            const miCuentaButton = document.getElementById('miCuentaButton');
            const logoutLink = document.getElementById('logoutLink');
            const viewProfileLink = document.getElementById('viewProfileLink'); // Aunque no se usa directamente aquí, es buena práctica mantener la referencia
            
            const clientNotifToggle = document.getElementById('clientNotifToggle');
            const clientNotifDropdown = document.getElementById('clientNotifDropdown');
            const clientNotifDot = document.querySelector('.client-notif-dot');
            const notificationList = document.getElementById('notificationList');

            // Elementos del Modal personalizado
            const clientModal = document.getElementById('clientModal');
            const clientModalMessage = document.getElementById('clientModalMessage');
            const clientModalActions = document.getElementById('clientModalActions');
            const clientCloseButton = document.querySelector('.client-modal-content .client-close-button');

            /**
             * @brief Muestra un modal personalizado con un mensaje y acciones opcionales.
             * @param {string} message - El mensaje a mostrar en el modal.
             * @param {string} [type='info'] - Tipo de mensaje ('info', 'success', 'error', 'warning').
             * @param {Array<Object>} [actions=[]] - Array de objetos { text: string, type: string, handler: function }.
             */
            function showModal(message, type = 'info', actions = []) {
                clientModalMessage.textContent = message;
                clientModalMessage.className = `client-message-text client-message-${type}`;
                clientModalActions.innerHTML = ''; // Limpiar acciones previas

                if (actions.length > 0) {
                    actions.forEach(action => {
                        const button = document.createElement('button');
                        button.textContent = action.text;
                        button.className = `client-modal-btn client-modal-${action.type}`;
                        button.onclick = () => {
                            clientModal.style.display = 'none';
                            if (action.handler) {
                                action.handler();
                            }
                        };
                        clientModalActions.appendChild(button);
                    });
                } else {
                    // Botón OK por defecto si no se proporcionan acciones
                    const okButton = document.createElement('button');
                    okButton.textContent = 'OK';
                    okButton.className = 'client-modal-btn';
                    okButton.onclick = () => clientModal.style.display = 'none';
                    clientModalActions.appendChild(okButton);
                }
                clientModal.style.display = 'flex'; // Usar flexbox para centrar
            }

            // Event listeners para cerrar el modal
            clientCloseButton.onclick = () => {
                clientModal.style.display = 'none';
            };
            window.onclick = (event) => {
                if (event.target === clientModal) {
                    clientModal.style.display = 'none';
                }
            };

            // --- Lógica de Autenticación y Carga de Datos del Perfil ---
            const token = localStorage.getItem('jwtToken');
            const userName = localStorage.getItem('userName');
            const userEmail = localStorage.getItem('userEmail'); 
            const userRole = localStorage.getItem('userRole');
            const userId = localStorage.getItem('userId'); 

            // Redirigir si no hay sesión activa o falta información esencial
            if (!token || !userName || !userRole || !userId) {
                console.warn('No hay sesión activa o falta información esencial. Redirigiendo a login.');
                showModal('Para ver tu perfil, necesitas iniciar sesión.', 'error', [{
                    text: 'Ir a Iniciar Sesión',
                    type: 'confirm',
                    handler: () => window.location.replace('../login.html') 
                }]);
                return; // Detener la ejecución del script si no hay sesión
            }

            // Actualizar el botón "Mi Cuenta" con el nombre del usuario
            miCuentaButton.textContent = `Hola, ${userName}`;

            // Mostrar datos básicos desde localStorage (pueden ser actualizados por el fetch)
            userNameDisplay.textContent = userName;
            userEmailDisplay.textContent = userEmail || 'No disponible';
            userRoleDisplay.textContent = userRole;

            /**
             * @brief Obtiene los datos del perfil del usuario desde el backend.
             */
            async function fetchUserProfile() {
                try {
                    // Endpoint para obtener datos de un usuario específico (usando /me ya que el token valida el ID)
                    const response = await fetch(`${API_URL}/api/usuarios/me`, { 
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}` // Incluir el token JWT para autenticación
                        }
                    });
                    const data = await response.json();

                    if (response.ok) {
                        const user = data.usuario; // El backend devuelve { usuario: { ... } }
                        userNameDisplay.textContent = user.Nom_Usuario || userName;
                        userEmailDisplay.textContent = user.Correo_Usuario || userEmail || 'No disponible';
                        userRoleDisplay.textContent = user.Rol_Usuario || userRole;
                        userPointsDisplay.textContent = user.Puntos_Teycketan !== undefined ? user.Puntos_Teycketan : '0';
                        // Asumiendo 100 puntos = S/1.00. Ajusta este factor si tu lógica es diferente.
                        userPointsEquivalent.textContent = (user.Puntos_Teycketan * 0.01).toFixed(2); 

                    } else {
                        console.error('Error al cargar el perfil del usuario:', data.mensaje || 'Error desconocido');
                        showModal(`Error al cargar tu perfil: ${data.mensaje || 'Inténtalo de nuevo.'}`, 'error');
                    }
                } catch (error) {
                    console.error('Error de red al cargar el perfil:', error);
                    showModal('Error de conexión con el servidor al cargar tu perfil.', 'error');
                }
            }

            /**
             * @brief Obtiene el historial de compras del usuario desde el backend.
             */
            async function fetchPurchaseHistory() {
                historialComprasBody.innerHTML = '<tr><td colspan="4">Cargando historial de compras...</td></tr>';
                noPurchasesMessage.style.display = 'none';

                try {
                    // Endpoint para obtener las compras de un usuario específico
                    const response = await fetch(`${API_URL}/api/compras/usuario/${userId}`, { 
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}` 
                        }
                    });
                    const data = await response.json();

                    if (response.ok) {
                        const purchases = data.purchases; // Asumiendo que el backend envía { purchases: [...] }
                        if (purchases && purchases.length > 0) {
                            historialComprasBody.innerHTML = ''; // Limpiar filas de carga
                            purchases.forEach(purchase => {
                                // Formatear la fecha para una mejor visualización
                                const formattedDate = new Date(purchase.Fecha_Compra).toLocaleDateString('es-ES', { 
                                    day: '2-digit', 
                                    month: 'long', 
                                    year: 'numeric', 
                                    hour: '2-digit', 
                                    minute: '2-digit' 
                                });
                                historialComprasBody.innerHTML += `
                                    <tr>
                                        <td>${purchase.Nom_Evento || 'Evento Desconocido'}</td>
                                        <td>${formattedDate}</td>
                                        <td>${purchase.Cantidad_Tickets}</td>
                                        <td>S/ ${(purchase.Precio_Total).toFixed(2)}</td>
                                    </tr>
                                `;
                            });
                        } else {
                            historialComprasBody.innerHTML = ''; // Asegurarse de que la tabla esté vacía
                            noPurchasesMessage.style.display = 'block'; // Mostrar mensaje de no hay compras
                        }
                    } else {
                        console.error('Error al cargar historial de compras:', data.message || 'Error desconocido');
                        historialComprasBody.innerHTML = `<tr><td colspan="4">Error al cargar el historial: ${data.message || 'Inténtalo de nuevo.'}</td></tr>`;
                    }
                } catch (error) {
                    console.error('Error de red al cargar historial de compras:', error);
                    historialComprasBody.innerHTML = `<tr><td colspan="4">Error de conexión al cargar el historial.</td></tr>`;
                }
            }

            // Cargar datos del perfil y el historial de compras al iniciar la página
            fetchUserProfile();
            fetchPurchaseHistory();

            // --- Event Listener para Cerrar Sesión ---
            logoutLink.addEventListener('click', (e) => {
                e.preventDefault();
                showModal('¿Estás seguro de que quieres cerrar sesión?', 'info', [
                    {
                        text: 'Sí, Cerrar Sesión',
                        type: 'confirm',
                        handler: () => {
                            localStorage.removeItem('jwtToken');
                            localStorage.removeItem('userName');
                            localStorage.removeItem('userEmail');
                            localStorage.removeItem('userRole');
                            localStorage.removeItem('userId');
                            window.location.replace('../principal.html'); // Redirigir a la página principal pública
                        }
                    },
                    {
                        text: 'Cancelar',
                        type: 'cancel',
                        handler: () => {} // Solo cerrar el modal
                    }
                ]);
            });

            // --- Lógica para el dropdown de notificaciones ---
            clientNotifToggle.addEventListener('click', (event) => {
                event.stopPropagation(); // Evitar que el clic se propague y cierre el dropdown inmediatamente
                clientNotifDropdown.style.display = clientNotifDropdown.style.display === 'block' ? 'none' : 'block';
                // Opcional: Ocultar el punto de notificación cuando se abre el dropdown
                clientNotifDot.style.display = 'none';
            });

            // Cerrar el dropdown de notificaciones si se hace clic fuera de él
            document.addEventListener('click', (event) => {
                if (!clientNotifDropdown.contains(event.target) && !clientNotifToggle.contains(event.target)) {
                    clientNotifDropdown.style.display = 'none';
                }
            });

            // Función global para alternar la visibilidad del historial de compras
            window.toggleHistorial = function() {
                const tabla = document.getElementById('historialCompras');
                tabla.classList.toggle('oculto');
                // Opcional: Si la tabla está oculta, recargar el historial cuando se muestre
                if (!tabla.classList.contains('oculto')) {
                    fetchPurchaseHistory(); 
                }
            };
        });
    </script>
</body>
</html>
