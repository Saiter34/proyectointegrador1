<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Perfil - Teycketan</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="perfil.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
    <!-- Fondos -->
    <div class="fondo-overlay-extra"></div>
    <div class="fondo-overlay"></div>

    <!-- Header -->
    <header class="encabezado">
        <div class="logo">
            <!-- Modificado para que el logo dirija a cliente.html -->
            <a href="cliente.html">
                <img src="../img/logo.png" alt="Logo de Teycketan">
            </a>
        </div>
        <nav>
            <div class="nav-box" id="organizerLinkContainer">
                <a href="../Proveedor/bienvenidoprov.html" id="organizerLink">¿Quieres ser organizador?</a>
            </div>

            <div class="nav-box dropdown">
                <button>Categorías</button>
                <div class="dropdown-content">
                    <a href="categoriasprincipal.html?categoria=Conciertos">Conciertos</a>
                    <a href="categoriasprincipal.html?categoria=Teatro">Teatro</a>
                    <a href="categoriasprincipal.html?categoria=Deportiva">Deportes</a> 
                </div>
            </div>

            <div class="nav-box dropdown" id="miCuentaContainer">
                <button id="miCuentaButton">Mi Cuenta</button>
                <div class="dropdown-content" id="miCuentaDropdownContent">
                    <a href="perfil.html" id="viewProfileLink">Ver Perfil</a>
                    <a href="#" id="logoutLink">Cerrar Sesión</a>
                </div>
            </div>
            <div class="client-notif-wrapper">
                <button class="client-notif-btn" id="clientNotifToggle">
                    <i class="fas fa-bell"></i>
                    <span class="client-notif-dot"></span>
                </button>
                <div class="client-notif-dropdown" id="clientNotifDropdown">
                    <p class="client-notif-title">Notificaciones</p>
                    <ul id="notificationListHeader">
                        <li>No tienes notificaciones nuevas.</li>
                    </ul>
                </div>
            </div>
        </nav>
        <script src="../js/verificar-cliente.js"></script>
    </header>

    <!-- Contenido principal -->
    <div class="perfil-dashboard">
        <!-- Menú lateral izquierdo -->
        <aside class="perfil-sidebar">
            <div class="perfil-foto-box">
                <img src="../img/imagen.jpg" alt="Foto de perfil" />
            </div>
            <h3 id="userNameDisplaySidebar">Cargando...</h3>
            <span id="userRoleDisplaySidebar" class="perfil-rol">Cargando...</span>

            <nav class="perfil-menu">
                <a href="#datos-personales" class="active" data-section="personalDataSection">Datos Personales</a>
                <a href="#puntos-teycketan" data-section="pointsSection">Puntos Teycketan</a>
                <a href="#historial-compras" data-section="historySection">Historial de Compras</a>
                <a href="#notificaciones" data-section="notificationsSection">Notificaciones</a>
            </nav>
        </aside>

        <!-- Panel derecho principal -->
        <section class="perfil-panel">

            <!-- Sección Datos Personales -->
            <div id="personalDataSection" class="perfil-box perfil-datos-flex active-section">
                <h2>Mi Perfil</h2>
                <div class="perfil-datos">
                    <p><strong>Nombre:</strong> <span id="userNameDisplay">Cargando...</span></p>
                    <p><strong>Email:</strong> <span id="userEmailDisplay">Cargando...</span></p>
                    <p><strong>Rol:</strong> <span id="userRoleDisplay">Cargando...</span></p>
                    <button class="btn-editar" id="editProfileButton">Editar Perfil</button>
                </div>
            </div>

            <!-- Sección Puntos Teycketan -->
            <div id="pointsSection" class="perfil-box" style="display: none;">
                <h2>Puntos Teycketan</h2>
                <div class="perfil-puntos">
                    <p>Tienes <span id="userPointsDisplay">0</span> puntos Teycketan.</p>
                    <p>Equivalente a: S/ <span id="userPointsEquivalent">0.00</span></p>
                    <p class="info-puntos">100 puntos = S/ 1.00</p>
                </div>
            </div>

            <!-- Sección Historial de Compras -->
            <div id="historySection" class="perfil-box" style="display: none;">
                <h2>Historial de Compras</h2>
                <div class="perfil-historial">
                    <table>
                        <thead>
                            <tr>
                                <th>Evento</th>
                                <th>Fecha de Compra</th>
                                <th>Cantidad</th>
                                <th>Total Pagado</th>
                            </tr>
                        </thead>
                        <tbody id="historialComprasBody">
                            <tr><td colspan="4">Cargando historial de compras...</td></tr>
                        </tbody>
                    </table>
                    <p id="noPurchasesMessage" class="no-data-message" style="display: none;">No tienes compras registradas aún.</p>
                </div>
            </div>

            <!-- Sección Notificaciones -->
            <div id="notificationsSection" class="perfil-box" style="display: none;">
                <h2>Notificaciones</h2>
                <div class="perfil-notificaciones">
                    <ul id="notificationListSection">
                        <li>No tienes notificaciones nuevas.</li>
                    </ul>
                    <p id="noNotificationsMessage" class="no-data-message" style="display: none;">No tienes notificaciones nuevas.</p>
                </div>
            </div>

        </section>
    </div>

    <footer>
        <img src="../img/logo.png" alt="Logo Footer" class="logo-footer" />
    </footer>

    <!-- Custom Modal for Alerts/Confirmations (General Purpose) -->
    <div id="clientModal" class="client-modal">
        <div class="client-modal-content">
            <span class="client-close-button">&times;</span>
            <p id="clientModalMessage" class="client-message-text"></p>
            <div id="clientModalActions">
            </div>
        </div>
    </div>

    <!-- Nuevo: Modal de Edición de Perfil -->
    <div id="editProfileModal" class="client-modal">
        <div class="client-modal-content">
            <span class="client-close-button edit-profile-close">&times;</span>
            <h2>Editar Perfil</h2>
            <form id="editProfileForm" class="edit-profile-form">
                <div class="form-group">
                    <label for="editUserName">Nombre:</label>
                    <input type="text" id="editUserName" name="Nom_Usuario" required>
                </div>
                <div class="form-group">
                    <label for="editUserApellido">Apellido:</label>
                    <input type="text" id="editUserApellido" name="Ape_Usuario" required>
                </div>
                <div class="form-group">
                    <label for="editUserEmail">Email:</label>
                    <input type="email" id="editUserEmail" name="Correo_Usuario" required disabled> <!-- Email no editable -->
                </div>
                <div class="form-group">
                    <label for="editUserTelefono">Teléfono:</label>
                    <input type="text" id="editUserTelefono" name="Tlf_Usuario">
                </div>
                <div class="form-actions">
                    <button type="submit" class="client-modal-btn client-modal-confirm">Guardar Cambios</button>
                    <button type="button" class="client-modal-btn client-modal-cancel edit-profile-close">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000'; // Asegúrate de que esta URL sea correcta para tu backend

        document.addEventListener('DOMContentLoaded', () => {
            // Referencias a elementos del DOM
            const userNameDisplaySidebar = document.getElementById('userNameDisplaySidebar');
            const userRoleDisplaySidebar = document.getElementById('userRoleDisplaySidebar');
            const userNameDisplay = document.getElementById('userNameDisplay');
            const userEmailDisplay = document.getElementById('userEmailDisplay');
            const userRoleDisplay = document.getElementById('userRoleDisplay');
            const userPointsDisplay = document.getElementById('userPointsDisplay');
            const userPointsEquivalent = document.getElementById('userPointsEquivalent');
            const historialComprasBody = document.getElementById('historialComprasBody');
            const noPurchasesMessage = document.getElementById('noPurchasesMessage');
            const miCuentaButton = document.getElementById('miCuentaButton');
            const logoutLink = document.getElementById('logoutLink');
            const organizerLinkContainer = document.getElementById('organizerLinkContainer');
            const editProfileButton = document.getElementById('editProfileButton'); 

            // Elementos de Notificaciones (en el header)
            const clientNotifToggle = document.getElementById('clientNotifToggle');
            const clientNotifDropdown = document.getElementById('clientNotifDropdown');
            const clientNotifDot = document.querySelector('.client-notif-dot');
            const notificationListHeader = document.getElementById('notificationListHeader');

            // Elementos de Notificaciones (en la sección de perfil)
            const notificationListSection = document.getElementById('notificationListSection');
            const noNotificationsMessage = document.getElementById('noNotificationsMessage');

            // Elementos del Modal personalizado (general)
            const clientModal = document.getElementById('clientModal');
            const clientModalMessage = document.getElementById('clientModalMessage');
            const clientModalActions = document.getElementById('clientModalActions');
            const clientCloseButton = document.querySelector('.client-modal-content .client-close-button');

            // Elementos del Modal de Edición de Perfil (específico)
            const editProfileModal = document.getElementById('editProfileModal');
            const editProfileCloseButtons = document.querySelectorAll('.edit-profile-close');
            const editProfileForm = document.getElementById('editProfileForm');
            const editUserName = document.getElementById('editUserName');
            const editUserApellido = document.getElementById('editUserApellido'); 
            const editUserEmail = document.getElementById('editUserEmail');
            const editUserTelefono = document.getElementById('editUserTelefono'); 


            // Referencias a las secciones de contenido y enlaces del sidebar
            const personalDataSection = document.getElementById('personalDataSection');
            const pointsSection = document.getElementById('pointsSection');
            const historySection = document.getElementById('historySection');
            const notificationsSection = document.getElementById('notificationsSection');
            const sidebarLinks = document.querySelectorAll('.perfil-menu a');
            const allContentSections = document.querySelectorAll('.perfil-panel > div');


            /**
             * @brief Muestra un modal personalizado con un mensaje y acciones opcionales.
             * @param {string} message - El mensaje a mostrar en el modal.
             * @param {string} [type='info'] - Tipo de mensaje ('info', 'success', 'error', 'warning').
             * @param {Array<Object>} [actions=[]] - Array de objetos { text: string, type: string, handler: function }.
             */
            function showModal(message, type = 'info', actions = []) {
                // Solo muestra el modal si hay un mensaje para evitar cuadros vacíos
                if (!message || message.trim() === '') {
                    console.warn('showModal called with empty message. Not displaying modal.');
                    return;
                }
                clientModalMessage.textContent = message;
                clientModalMessage.className = `client-message-text client-message-${type}`;
                clientModalActions.innerHTML = ''; // Limpiar acciones previas

                if (actions.length > 0) {
                    actions.forEach(action => {
                        const button = document.createElement('button');
                        button.textContent = action.text;
                        button.className = `client-modal-btn client-modal-${action.type}`;
                        button.onclick = () => {
                            clientModal.style.display = 'none';
                            if (action.handler) {
                                action.handler();
                            }
                        };
                        clientModalActions.appendChild(button);
                    });
                } else {
                    const okButton = document.createElement('button');
                    okButton.textContent = 'OK';
                    okButton.className = 'client-modal-btn';
                    okButton.onclick = () => clientModal.style.display = 'none';
                    clientModalActions.appendChild(okButton);
                }
                clientModal.style.display = 'flex'; 
            }

            // Cierra el modal general
            clientCloseButton.onclick = () => {
                clientModal.style.display = 'none';
            };
            window.onclick = (event) => {
                if (event.target === clientModal) {
                    clientModal.style.display = 'none';
                }
                // También cierra el modal de edición si se hace clic fuera
                if (event.target === editProfileModal) {
                    editProfileModal.style.display = 'none';
                }
            };

            // Cierra el modal de edición
            editProfileCloseButtons.forEach(button => {
                button.onclick = () => {
                    editProfileModal.style.display = 'none';
                };
            });


            /**
             * @brief Limpia el localStorage y redirige al login.
             * @param {string} message - Mensaje a mostrar al usuario.
             */
            function forceLogout(message) {
                localStorage.removeItem('jwtToken');
                localStorage.removeItem('userName');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('userRole');
                localStorage.removeItem('userId');
                localStorage.removeItem('puntos');
                localStorage.removeItem('usadoPrimeraCompra');
                showModal(message, 'error', [{
                    text: 'Ir a Iniciar Sesión',
                    type: 'confirm',
                    handler: () => window.location.replace('../login.html')
                }]);
            }

            // --- Lógica de Autenticación y Carga de Datos del Perfil ---
            const token = localStorage.getItem('jwtToken');
            const userName = localStorage.getItem('userName');
            const userEmail = localStorage.getItem('userEmail'); 
            const userRole = localStorage.getItem('userRole');
            const userId = localStorage.getItem('userId'); 

            if (!token || !userName || !userRole || !userId) {
                console.warn('No hay sesión activa o falta información esencial. Redirigiendo a login.');
                forceLogout('Para ver tu perfil, necesitas iniciar sesión.');
                return; 
            }

            miCuentaButton.textContent = `Hola, ${userName}`;

            if (userRole === 'organizador' || userRole === 'admin' || userRole === 'pendiente_organizador') { 
                if (organizerLinkContainer) {
                    organizerLinkContainer.style.display = 'none';
                }
            } else {
                if (organizerLinkContainer) {
                    organizerLinkContainer.style.display = 'block';
                }
            }

            // Estas actualizaciones iniciales son solo placeholders, se llenarán con fetchUserProfile
            userNameDisplaySidebar.textContent = userName;
            userRoleDisplaySidebar.textContent = userRole;
            userNameDisplay.textContent = userName;
            userEmailDisplay.textContent = userEmail || 'No disponible';
            userRoleDisplay.textContent = userRole;


            /**
             * @brief Obtiene los datos del perfil del usuario desde el backend.
             */
            async function fetchUserProfile() {
                try {
                    const response = await fetch(`${API_URL}/api/usuarios/me`, { 
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const data = await response.json();

                    if (response.ok) {
                        const user = data.usuario;
                        userNameDisplaySidebar.textContent = user.Nom_Usuario || 'N/A';
                        userRoleDisplaySidebar.textContent = user.Rol_Usuario || 'N/A';
                        userNameDisplay.textContent = user.Nom_Usuario || 'N/A';
                        userEmailDisplay.textContent = user.Correo_Usuario || 'No disponible';
                        userRoleDisplay.textContent = user.Rol_Usuario || 'N/A';
                        userPointsDisplay.textContent = user.Puntos_Teycketan !== undefined ? user.Puntos_Teycketan : '0';
                        userPointsEquivalent.textContent = (parseFloat(user.Puntos_Teycketan || 0) * 0.01).toFixed(2); 

                        // Rellenar el formulario de edición con los datos actuales
                        editUserName.value = user.Nom_Usuario || '';
                        editUserApellido.value = user.Ape_Usuario || '';
                        editUserEmail.value = user.Correo_Usuario || '';
                        editUserTelefono.value = user.Tlf_Usuario || '';

                    } else if (response.status === 401 || response.status === 403) {
                        forceLogout('Tu sesión ha caducado. Por favor, inicia sesión de nuevo.');
                    } else {
                        console.error('Error al cargar el perfil del usuario:', data.mensaje || 'Error desconocido');
                        showModal(`Error al cargar tu perfil: ${data.mensaje || 'Inténtalo de nuevo.'}`, 'error');
                    }
                } catch (error) {
                    console.error('Error de red al cargar el perfil:', error);
                    showModal('Error de conexión con el servidor al cargar tu perfil.', 'error');
                }
            }

            /**
             * @brief Obtiene el historial de compras del usuario desde el backend.
             */
            async function fetchPurchaseHistory() {
                historialComprasBody.innerHTML = '<tr><td colspan="4">Cargando historial de compras...</td></tr>';
                noPurchasesMessage.style.display = 'none';

                try {
                    const response = await fetch(`${API_URL}/api/compras/usuario/${userId}`, { 
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}` 
                        }
                    });
                    const data = await response.json();
                    // console.log('Datos del historial de compras recibidos:', data); // Debugging log

                    if (response.ok) {
                        const purchases = data.purchases;
                        if (purchases && purchases.length > 0) {
                            historialComprasBody.innerHTML = '';
                            purchases.forEach(purchase => {
                                const formattedDate = new Date(purchase.Fecha_Compra).toLocaleDateString('es-ES', { 
                                    day: '2-digit', 
                                    month: 'long', 
                                    year: 'numeric', 
                                    hour: '2-digit', 
                                    minute: '2-digit' 
                                });
                                const precioTotal = parseFloat(purchase.Precio_Total);
                                historialComprasBody.innerHTML += `
                                    <tr>
                                        <td>${purchase.Nom_Evento || 'Evento Desconocido'}</td>
                                        <td>${formattedDate}</td>
                                        <td>${purchase.Cantidad_Tickets}</td>
                                        <td>S/ ${isNaN(precioTotal) ? '0.00' : precioTotal.toFixed(2)}</td>
                                    </tr>
                                `;
                            });
                        } else {
                            historialComprasBody.innerHTML = '';
                            noPurchasesMessage.style.display = 'block';
                        }
                    } else if (response.status === 401 || response.status === 403) {
                        forceLogout('Tu sesión ha caducado. Por favor, inicia sesión de nuevo para ver tu historial.');
                    } else {
                        console.error('Error al cargar historial de compras:', data.message || 'Error desconocido');
                        historialComprasBody.innerHTML = `<tr><td colspan="4">Error al cargar el historial: ${data.message || 'Inténtalo de nuevo.'}</td></tr>`;
                    }
                } catch (error) {
                    console.error('Error de red al cargar historial de compras:', error);
                    historialComprasBody.innerHTML = `<tr><td colspan="4">Error de conexión al cargar el historial.</td></tr>`;
                }
            }

            /**
             * @brief Obtiene y renderiza las notificaciones del usuario.
             */
            async function fetchNotifications() {
                notificationListSection.innerHTML = '<li>Cargando notificaciones...</li>';
                notificationListHeader.innerHTML = '<li>Cargando notificaciones...</li>';
                noNotificationsMessage.style.display = 'none';
                clientNotifDot.style.display = 'none';

                try {
                    const response = await fetch(`${API_URL}/api/notificaciones/usuario/${userId}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const data = await response.json();
                    // console.log('Datos de notificaciones recibidos:', data); // Debugging log

                    if (response.ok) {
                        const notifications = data.notifications;
                        if (notifications && notifications.length > 0) {
                            notificationListSection.innerHTML = '';
                            notificationListHeader.innerHTML = '';
                            let unreadCount = 0;

                            notifications.forEach(notif => {
                                const formattedDate = new Date(notif.Fecha_Creacion).toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });
                                
                                // Create list item for the main notifications section
                                const liSection = document.createElement('li');
                                liSection.textContent = `${formattedDate}: ${notif.Mensaje}`;
                                liSection.classList.add('notification-item'); 
                                if (!notif.Leida) {
                                    liSection.classList.add('unread');
                                    unreadCount++;
                                }
                                liSection.addEventListener('click', () => markNotificationAsRead(notif.Id_Notificacion));
                                notificationListSection.appendChild(liSection);

                                // Create list item for the header dropdown
                                const liHeader = document.createElement('li');
                                liHeader.textContent = `${formattedDate}: ${notif.Mensaje}`;
                                liHeader.classList.add('notification-item'); 
                                if (!notif.Leida) {
                                    liHeader.classList.add('unread');
                                }
                                // Clicking header notification should navigate to the notifications section
                                liHeader.addEventListener('click', () => {
                                    markNotificationAsRead(notif.Id_Notificacion); 
                                    window.location.href = 'perfil.html#notificaciones';
                                    clientNotifDropdown.style.display = 'none'; 
                                });
                                notificationListHeader.appendChild(liHeader);
                            });

                            if (unreadCount > 0) {
                                clientNotifDot.style.display = 'block';
                            } else {
                                clientNotifDot.style.display = 'none';
                            }

                        } else {
                            notificationListSection.innerHTML = '<li>No tienes notificaciones nuevas.</li>';
                            notificationListHeader.innerHTML = '<li>No tienes notificaciones nuevas.</li>';
                            noNotificationsMessage.style.display = 'block';
                            clientNotifDot.style.display = 'none';
                        }
                    } else if (response.status === 401 || response.status === 403) {
                        forceLogout('Tu sesión ha caducado. Por favor, inicia sesión de nuevo para ver tus notificaciones.');
                    } else {
                        console.error('Error al cargar notificaciones:', data.message || 'Error desconocido');
                        notificationListSection.innerHTML = '<li>Error al cargar notificaciones.</li>';
                        notificationListHeader.innerHTML = '<li>Error al cargar notificaciones.</li>';
                    }
                } catch (error) {
                    console.error('Error de red al cargar notificaciones:', error);
                    notificationListSection.innerHTML = '<li>Error de conexión al cargar notificaciones.</li>';
                    notificationListHeader.innerHTML = '<li>Error de conexión al cargar notificaciones.</li>';
                }
            }

            /**
             * @brief Marca una notificación como leída en el backend y actualiza el frontend.
             * @param {number} notificationId - El ID de la notificación a marcar como leída.
             */
            async function markNotificationAsRead(notificationId) {
                try {
                    const response = await fetch(`${API_URL}/api/notificaciones/${notificationId}/mark-as-read`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        // console.log(`Notificación ${notificationId} marcada como leída.`);
                        fetchNotifications(); 
                    } else if (response.status === 401 || response.status === 403) {
                        forceLogout('Tu sesión ha caducado. Por favor, inicia sesión de nuevo.');
                    } else {
                        const data = await response.json();
                        console.error('Error al marcar notificación como leída:', data.message || 'Error desconocido');
                    }
                } catch (error) {
                    console.error('Error de red al marcar notificación como leída:', error);
                }
            }

            // --- Lógica para alternar secciones del perfil ---
            function showSection(sectionId) {
                allContentSections.forEach(section => {
                    section.style.display = 'none';
                    section.classList.remove('active-section');
                });
                sidebarLinks.forEach(link => {
                    link.classList.remove('active');
                });

                const targetSection = document.getElementById(sectionId);
                if (targetSection) {
                    targetSection.style.display = 'block';
                    targetSection.classList.add('active-section');
                }

                const targetLink = document.querySelector(`.perfil-menu a[data-section="${sectionId}"]`);
                if (targetLink) {
                    targetLink.classList.add('active');
                }

                // Recargar datos específicos de la sección al mostrarla
                if (sectionId === 'personalDataSection') {
                    fetchUserProfile();
                } else if (sectionId === 'pointsSection') {
                    fetchUserProfile(); 
                } else if (sectionId === 'historySection') {
                    fetchPurchaseHistory();
                } else if (sectionId === 'notificationsSection') {
                    fetchNotifications();
                }
            }

            // Manejar la navegación inicial y los clics en el sidebar
            const initialSectionHash = window.location.hash.substring(1);
            let initialSectionId = 'personalDataSection';
            if (initialSectionHash) {
                if (initialSectionHash === 'datos-personales') initialSectionId = 'personalDataSection';
                else if (initialSectionHash === 'puntos-teycketan') initialSectionId = 'pointsSection';
                else if (initialSectionHash === 'historial-compras') initialSectionId = 'historySection';
                else if (initialSectionHash === 'notificaciones') initialSectionId = 'notificationsSection';
            }
            showSection(initialSectionId);


            // Adjuntar event listeners a los enlaces del sidebar
            sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const sectionId = link.dataset.section;
                    if (sectionId) {
                        showSection(sectionId);
                        history.pushState(null, '', `perfil.html${link.getAttribute('href')}`);
                    }
                });
            });

            // --- Event Listener para el botón "Editar Perfil" ---
            editProfileButton.addEventListener('click', () => {
                // Asegúrate de que los datos actuales estén cargados en el formulario antes de mostrar el modal
                fetchUserProfile().then(() => { 
                    editProfileModal.style.display = 'flex'; // Muestra el modal de edición
                }).catch(error => {
                    console.error("Error al cargar datos para edición:", error);
                    showModal("No se pudieron cargar los datos para editar el perfil.", "error");
                });
            });

            // --- Manejo del envío del formulario de edición de perfil ---
            editProfileForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const updatedData = {
                    Nom_Usuario: editUserName.value,
                    Ape_Usuario: editUserApellido.value,
                    Tlf_Usuario: editUserTelefono.value
                };

                try {
                    const response = await fetch(`${API_URL}/api/usuarios/${userId}`, { 
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(updatedData)
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showModal('Tu perfil ha sido actualizado exitosamente.', 'success');
                        editProfileModal.style.display = 'none'; 
                        fetchUserProfile(); // Recarga los datos para que se reflejen los cambios
                        
                        // Actualizar localStorage con los nuevos datos si es necesario (ej. nombre)
                        localStorage.setItem('userName', updatedData.Nom_Usuario);
                        // No es necesario actualizar el email, ya que está deshabilitado para edición
                        if (updatedData.Ape_Usuario) localStorage.setItem('userApellido', updatedData.Ape_Usuario); // Si guardas apellido en localStorage
                        if (updatedData.Tlf_Usuario) localStorage.setItem('userTelefono', updatedData.Tlf_Usuario); // Si guardas teléfono en localStorage

                        miCuentaButton.textContent = `Hola, ${updatedData.Nom_Usuario}`; 
                        userNameDisplaySidebar.textContent = updatedData.Nom_Usuario; 
                        
                        // Enviar notificación al backend sobre el cambio de perfil
                        sendNotificationToBackend(userId, 'Tu perfil ha sido actualizado.', 'perfil'); // Tipo 'perfil'

                    } else if (response.status === 401 || response.status === 403) {
                        forceLogout('Tu sesión ha caducado. Por favor, inicia sesión de nuevo.');
                    } else {
                        showModal(`Error al actualizar el perfil: ${data.mensaje || 'Inténtalo de nuevo.'}`, 'error');
                        console.error('Error al actualizar perfil:', data.mensaje || 'Error desconocido');
                    }
                } catch (error) {
                    console.error('Error de red al actualizar perfil:', error);
                    showModal('Error de conexión con el servidor al actualizar el perfil.', 'error');
                }
            });

            // Función auxiliar para enviar notificaciones al backend
            async function sendNotificationToBackend(userId, message, type) {
                try {
                    const response = await fetch(`${API_URL}/api/notificaciones`, { 
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            id_usuario: userId,
                            mensaje: message,
                            tipo_notificacion: type || 'general' 
                        })
                    });
                    if (response.ok) {
                        console.log('Notificación enviada al backend.');
                        fetchNotifications(); // Recargar notificaciones en el frontend para que se vea la nueva
                    } else {
                        const errorData = await response.json();
                        console.error('Error al enviar notificación al backend:', errorData.message);
                    }
                } catch (error) {
                    console.error('Error de red al enviar notificación:', error);
                }
            }


            // --- Event Listener para Cerrar Sesión ---
            logoutLink.addEventListener('click', (e) => {
                e.preventDefault();
                showModal('¿Estás seguro de que quieres cerrar sesión?', 'info', [
                    {
                        text: 'Sí, Cerrar Sesión',
                        type: 'confirm',
                        handler: () => {
                            localStorage.removeItem('jwtToken');
                            localStorage.removeItem('userName');
                            localStorage.removeItem('userEmail');
                            localStorage.removeItem('userRole');
                            localStorage.removeItem('userId');
                            localStorage.removeItem('puntos');
                            localStorage.removeItem('usadoPrimeraCompra');
                            window.location.replace('../principal.html');
                        }
                    },
                    {
                        text: 'Cancelar',
                        type: 'cancel',
                        handler: () => {}
                    }
                ]);
            });

            // --- Lógica para el dropdown de notificaciones (en el header) ---
            clientNotifToggle.addEventListener('click', (event) => {
                event.stopPropagation(); 
                clientNotifDropdown.style.display = clientNotifDropdown.style.display === 'block' ? 'none' : 'block';
            });

            document.addEventListener('click', (event) => {
                if (!clientNotifDropdown.contains(event.target) && !clientNotifToggle.contains(event.target)) {
                    clientNotifDropdown.style.display = 'none';
                }
            });

            // Llamada inicial para cargar el perfil y notificaciones al cargar la página
            fetchUserProfile(); 
            fetchNotifications(); 
        });
    </script>
</body>
</html>
