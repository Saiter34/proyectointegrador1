<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teycketan - Mi Perfil</title>
    <link rel="stylesheet" href="cliente.css"> 
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
    <div class="overlay"></div>
    <main>
        <header class="encabezado">
            <div class="logo">
                <!-- Ruta ABSOLUTA desde la raíz servida por Express (Fronted/) -->
                <img src="/img/logo.png" alt="Logo de Teycketan">
            </div>
            <nav>
                <div class="nav-box" id="organizerLinkContainer" style="display: none;">
                    <!-- Ruta ABSOLUTA -->
                    <a href="/Cliente/bienvenidoprov.html" id="organizerLink">¿Quieres ser organizador?</a>
                </div>
                <div class="nav-box dropdown">
                    <button>Categorías</button>
                    <div class="dropdown-content">
                        <!-- Rutas RELATIVAS a Cliente/ -->
                        <a href="concierto.html">Conciertos</a>
                        <a href="teatro.html">Teatro</a>
                        <a href="deportes.html">Deportes</a>
                    </div>
                </div>
                <div class="nav-box dropdown" id="miCuentaContainer"> 
                    <button id="miCuentaButton">Mi Cuenta</button>
                    <div class="dropdown-content" id="miCuentaDropdownContent">
                        <a href="#" id="viewProfileLink">Ver Perfil</a>
                        <a href="#" id="logoutLink">Cerrar Sesión</a>
                    </div>
                </div>

                <!-- NOTIFICACIONES -->
                <div class="client-notif-wrapper">
                    <button class="client-notif-btn" id="clientNotifToggle">
                        <i class="fas fa-bell"></i>
                        <span class="client-notif-dot"></span>
                    </button>
                    <div class="client-notif-dropdown" id="clientNotifDropdown">
                        <p class="client-notif-title">Notificaciones</p>
                        <ul>
                            <li>Tu compra de "Concierto XYZ" fue exitosa!</li>
                            <li>Recordatorio: "Evento ABC" es mañana.</li>
                            <li>Nuevo evento "Festival de Verano" disponible.</li>
                        </ul>
                    </div>
                </div>
            </nav>
        </header>

        <div class="contenido-principal">
            <section class="damiano contenedor-estilo">
                <div class="info">
                    <h2>Your Damiano David</h2>
                    <p><strong>Música</strong> / Presencial</p>
                    <p>Damiano David en Lima</p>
                    <p>14 al 18 mayo 2025</p>
                    <a href="detalles.html" class="btn-vermas">Ver más</a> <!-- Ruta RELATIVA -->
                </div>
                <!-- Ruta ABSOLUTA -->
                <img src="/img/damiano.jpg" alt="Damiano David">
            </section>

            <aside class="destacados contenedor-estilo">
                <h3>Destacados</h3>
                <div class="circulos">
                    <a href="sanmarcos.html" class="circulo"> <!-- Ruta RELATIVA -->
                        <img src="/img/sanmarcos.png" alt="Estadio San Marcos"> <!-- Ruta ABSOLUTA -->
                        <span>San Marcos</span>
                    </a>
                    <a href="teatrocanut.html" class="circulo"> <!-- Ruta RELATIVA -->
                        <img src="/img/teatrocanout.jpg" alt="Teatro Canut"> <!-- Ruta ABSOLUTA -->
                        <span>Teatro Canut</span>
                    </a>
                    <a href="teatronacional.html" class="circulo"> <!-- Ruta RELATIVA -->
                        <img src="/img/teatronacional.jpg" alt="Teatro Nacional"> <!-- Ruta ABSOLUTA -->
                        <span>Teatro Nacional</span>
                    </a>
                </div>
            </aside>
        </div>

        <section class="eventos contenedor-estilo">
            <h3>Próximos eventos</h3>
            <div class="eventos-grid" id="proximos-eventos-grid">
                <p class="loading-events-message">Cargando próximos eventos...</p>
            </div>
        </section>

    </main>

    <footer class="footer-completo">
        <div class="container-footer">
            <div class="footer-row">
                <div class="footer-col">
                    <h4>Síguenos</h4>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-facebook-f"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-linkedin"></i></a>
                    </div>
                </div>
                <div class="footer-col">
                    <h4>Compañía</h4>
                    <ul>
                        <li><a href="#">Nosotros</a></li>
                        <li><a href="#">Servicios</a></li>
                        <li><a href="#">Política de Privacidad</a></li>
                        <li><a href="#">Califícanos</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Ayuda</h4>
                    <ul>
                        <li><a href="#">Teléfono: (999-999-999)</a></li>
                        <li><a href="#">Correo: Teycketan@gmail.com</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Métodos de pago</h4>
                    <div class="payment-methods">
                        <!-- Rutas ABSOLUTAS -->
                        <img src="/img/logo-yape.jpg" alt="Logo Yape">
                        <img src="/img/logo-plin.jpg" alt="Logo Plin">
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <small>&copy; 2024 <b>SLee Dw</b> - Todos los Derechos Reservados.</small>
            </div>
        </div>
        <!-- Ruta ABSOLUTA -->
        <img src="/img/logo.png" alt="Logo Teycketan" class="logo-footer"/>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_URL = 'http://localhost:3000'; 
            const miCuentaButton = document.getElementById('miCuentaButton');
            const organizerLinkContainer = document.getElementById('organizerLinkContainer');
            const proximosEventosGrid = document.getElementById('proximos-eventos-grid');
            const logoutLink = document.getElementById('logoutLink');
            const viewProfileLink = document.getElementById('viewProfileLink');

            // Elementos de la notificación para cliente.html
            const clientNotifToggle = document.getElementById('clientNotifToggle');
            const clientNotifDropdown = document.getElementById('clientNotifDropdown');

            // --- Lógica de Redirección y Control de Sesión ---
            const token = localStorage.getItem('jwtToken');
            const userName = localStorage.getItem('userName');
            const userRole = localStorage.getItem('userRole');

            if (!token || !userName || !userRole) {
                // Si NO hay token, o falta información vital, redirige a la página principal (pública).
                // Esto es crucial: cliente.html solo debe ser accesible si hay una sesión activa.
                console.warn('No hay sesión activa en cliente.html. Redirigiendo a la página principal pública.');
                window.location.replace('/principal.html'); // Ruta ABSOLUTA
                return; 
            }

            // Si hay token y userName, el usuario está logueado.
            miCuentaButton.textContent = `Hola, ${userName}`;

            // Mostrar u ocultar "¿Quieres ser organizador?" según el rol
            if (userRole === 'organizador' || userRole === 'admin') {
                if (organizerLinkContainer) {
                    organizerLinkContainer.style.display = 'none';
                }
            } else {
                if (organizerLinkContainer) {
                    organizerLinkContainer.style.display = 'block';
                }
            }

            // --- Lógica para cargar eventos (similar a principal.html) ---
            async function fetchApprovedEvents() {
                proximosEventosGrid.innerHTML = '<p class="loading-events-message">Cargando próximos eventos...</p>';
                try {
                    const response = await fetch(`${API_URL}/api/eventos/aprobados-para-cliente`);
                    const events = await response.json();

                    if (response.ok) {
                        if (events.length === 0) {
                            proximosEventosGrid.innerHTML = '<p class="no-events-found-message">No hay eventos disponibles en este momento. ¡Vuelve pronto!</p>';
                        } else {
                            renderEvents(events);
                        }
                    } else {
                        proximosEventosGrid.innerHTML = `<p class="error-message">Error al cargar eventos: ${events.message || 'Error desconocido'}</p>`;
                        console.error('Error fetching approved events:', events);
                    }
                }
                catch (error) {
                    proximosEventosGrid.innerHTML = '<p class="error-message">Error de conexión con el servidor. No se pudieron cargar los eventos.</p>';
                    console.error('Network error fetching approved events:', error);
                }
            }

            function renderEvents(events) {
                let eventsHtml = '';
                events.forEach(event => {
                    const formattedDate = new Date(event.Fecha).toLocaleDateString('es-ES', { day: '2-digit', month: 'long', year: 'numeric' });
                    const imageUrl = event.URL_Imagen ? `${API_URL}${event.URL_Imagen}` : 'https://placehold.co/150x100/cccccc/000000?text=No+Img';

                    eventsHtml += `
                        <a href="detalles.html?eventId=${event.Id_Evento}" class="evento-link"> <!-- Ruta RELATIVA -->
                            <div class="evento">
                                <img src="${imageUrl}" alt="${event.Nom_Evento}">
                                <div class="evento-info">
                                    <h4>${event.Nom_Evento}</h4>
                                    <p>${event.Ubicacion}</p>
                                    <p>${formattedDate}</p>
                                </div>
                            </div>
                        </a>
                    `;
                });
                proximosEventosGrid.innerHTML = eventsHtml;
            }

            fetchApprovedEvents();

            // --- Event Listeners para la navegación de usuario logueado ---
            viewProfileLink.addEventListener('click', (e) => {
                e.preventDefault();
                // Redirige al dashboard/perfil del cliente
                window.location.href = '/Cliente/cliente.html'; // Ruta ABSOLUTA para la propia página cliente.html
            });

            logoutLink.addEventListener('click', (e) => {
                e.preventDefault();
                // Considera usar un modal personalizado en lugar de `confirm`
                if (confirm('¿Estás seguro de que quieres cerrar sesión?')) { // SI ESTO ES UN PROBLEMA, DEBERÍAS IMPLEMENTAR UN MODAL PERSONALIZADO
                    localStorage.removeItem('jwtToken');
                    localStorage.removeItem('userName');
                    localStorage.removeItem('userEmail');
                    localStorage.removeItem('userRole');
                    localStorage.removeItem('userId'); 
                    window.location.replace('/principal.html'); // Ruta ABSOLUTA
                }
            });

            // --- Lógica para el dropdown de notificaciones (cliente.html) ---
            clientNotifToggle.addEventListener('click', (event) => {
                event.stopPropagation();
                clientNotifDropdown.style.display = clientNotifDropdown.style.display === 'block' ? 'none' : 'block';
            });

            document.addEventListener('click', (event) => {
                if (!clientNotifDropdown.contains(event.target) && !clientNotifToggle.contains(event.target)) {
                    clientNotifDropdown.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>
